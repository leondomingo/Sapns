{% extends 'base.html' %}

{% block middle %}

{% import 'util.html' as util %}
{{util.jquery()}}
{{util.jquery_ui()}}

<style type="text/css">
    .sp-edit-panel {
        overflow: auto;
    }
    
    .sp-save-button {
        position: fixed;
        right: 350px;
        width: 80px;
        height: 30px;
        text-align: center;
        background-color: #B4BD3C;
        border: 1px solid gray;
    }
    
    .sp-edit-field {
    }
    
    .sp-text-field {
        width: 90%;
        max-width: 90%;
        min-width: 90%;
        margin-left: 1%;
    }
    
    .sp-select-field {
        width: 85%;
        margin-left: 1%;
    }
    
    .sp-select-text {
        width: 90%;
        border: 1px solid gray;
    }
    
    .sp-select-text:focus {
        border: 1px solid orange;
    }
    
    .sp-checkbox-field {
        margin-left: 1%;
    }
    
    .sp-date-field {
        margin-left: 1%;
    }
    
    .sp-time-field {
        margin-left: 1%;
        width: 70px;
    }
    
    .sp-memo-field {
        min-height: 40px;
        height: 100px;
    }
</style>

<div id="edit-dialog" style="display: none;"></div>

<form id="edit-form" method="post" action="{{tg.url('/save')}}">
    <input type="hidden" name="cls" value="{{cls}}"/> 
    <input type="hidden" name="id" value="{{id}}"/>
</form>

<div class="sp-edit-panel">
    <div class="sp-save-button">
        <input id="save-button" class="sp-button" type="button" 
            value="{{_('Save')}}"/>
    </div>
    
    <div style="font-size: 25px; margin-left: 1%;">
        {{title}}
    </div>

    {% if reference %}
    <div style="margin-left: 1%; width: 97%; font-size: 15px; color: black; 
        background-color: none;">[{{reference}}]</div>
    {% endif %}
    
    <div style="height: 10px;">
    </div>
    
    {#{% for rc in related_classes %}
    <div>{{rc.name}}.{{rc.attr_name}}</div>
    {% endfor %}#}
    
    {% for attr in attributes %}
    <div class="sp-edit-field" 
        {% if attr.required %}
        required="true"
        {% else %}
        required="false" 
        {% endif %}
        attr-title="{{attr.title}}">
        
        <div class="sp-label-field" 
            style="margin-left: 10px; 
                margin-top: 4px;
                {% if attr.required %} font-weight: bold;  {% endif %}
                margin-bottom: 2px;">{{attr.title|escape}}</div>

        <div>
        <!-- Boolean -->
        {% if attr.type == 'Boolean' %}
        <input class="sp-checkbox-field" type="checkbox" name="{{attr.name}}"
            {% if attr.value %}checked{% endif %}/>
        
        <!-- Date -->
        {% elif attr.type == 'Date' %}
        <input class="sp-date-field" type="text" name="{{attr.name}}" 
            value="{{attr.value}}"/>
        
        <!-- Time -->
        {% elif attr.type == 'Time' %}
        <input class="sp-time-field" type="text" name="{{attr.name}}" 
            value="{{attr.value}}"/>            
        
        <!-- Memo -->
        {% elif attr.type == 'String' %}
        <textarea class="sp-text-field sp-memo-field" 
            name="{{attr.name}}">{{attr.value|escape}}</textarea>
        
        <!-- Select -->
        {% elif attr.related_class != None %}
          {% if attr.vals == None %}
          <div class="sp-select-field" name="{{attr.name}}"
              related_class="{{attr.related_class}}"
              value="{{attr.value}}">
              <input class="sp-select-text" type="text" readonly
                  value="{{attr.related_title}}" />
              <input class="sp-button sp-select-button" type="button" value="..."/>
              <input class="sp-button sp-empty-button" type="button" value="X"
                style="color: red;"/>
          </div>
          {#{% else %}
          <select class="sp-select-field" name="{{attr.name}}"
              related_class="{{attr.related_class}}">
              <option value="null" 
                  {% if attr.value == None %} selected {% endif %}>{{_('none')}}</option>
              {% for value in attr.vals %}
              <option value="{{value.id}}" 
                  {% if value.id == attr.value %}selected{%endif%}>{{value.title}}</option>
              {% endfor %}
          </select>
          <!--
          <a href="/list?cls={{attr.related_class}}" target="_blank"
              title="{{attr.related_class}}">[{{_('list')}}]</a>
              {% if attr.value %}
              <a href="/edit?cls={{attr.related_class}}&id={{attr.value}}" 
                  target="_blank">[{{_('edit')}}]</a>-->
          #}
          {% endif %}
        {% else %}
        <!-- Everything else -->
        <input class="sp-text-field" type="text" name="{{attr.name}}" 
            value="{{attr.value|escape}}"/>
        {% endif %}
        </div>
    </div>
    {% endfor %}
    <div style="height: 40px;">
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
    	
    	$('.sp-empty-button').click(function() {
    		$(this).parent().attr('value', '');
    		$(this).parent().find('.sp-select-text').attr('value', '');
    	});
    	
    	function click_search (button, related_class, q) {
    		
    		if (q == undefined) {
    			q = $('.sp-search-text').val();
    		}
    		
    		$.ajax({
                url: "{{tg.url('/search')}}",
                type: 'post',
                dataType: 'html',
                data: {
                    cls: related_class,
                    q: q,
                    rp: '100'
                },
                success: function(res) {
                    $('#edit-dialog').html(res);
                    
                    $('.sp-search-button').click(function() {
                        click_search(button, related_class);
                    });
                    
                    $('.sp-search-text').keypress(function(event) {
                        search_kp(event, $('.sp-search-button'), related_class);
                    }).val(q).focus();
                },
                error: function(res) {
                    alert('error!');
                    $('#edit-dialog').dialog('close');
                }
            });
    	}
    	
    	function search_kp(event, button, related_class) {
    		if (event.which == 13) {
                click_search(button, related_class);
            }
    	}
    	
    	$('.sp-select-button').click(function() {
    		var field = $(this).parent();    		
    		var related_class = field.attr('related_class');
    		
    		$('#edit-dialog').dialog({
            	title: related_class,
            	width: 950,
                height: 550,
                resizable: false,
                modal: true,
                buttons: {
                	"{{_('Ok')}}": function() {
                		// get the id of the selected row
                        var id_selected = '';
                        $('#edit-dialog .sp-grid .sp-grid-rowid').each(function() {
                            if ($(this).attr('checked') == true) {
                                id_selected = $(this).attr('id_row');
                            }
                        });
                        
                        if (id_selected != '') {
                        	$.ajax({
                        		url: "{{tg.url('/title')}}",
                        		type: "get",
                        		dataType: "json",
                        		data: {
                        			cls: related_class,
                        			id: id_selected
                        		},
                        		success: function(res) {
                        			field.find('.sp-select-text').val(res.title);
                        		},
                        		error: function() {
                        		}
                        	});
                        }
                        else {
                        	field.find('.sp-select-text').val('');
                        }
                        
                        field.attr('value', id_selected);
                		
                		$('#edit-dialog').dialog('close');
                	},
                	"{{_('Cancel')}}": function() {
                		$('#edit-dialog').dialog('close');
                	}
                }
            });
    		
    		click_search($('.sp-search-button'), related_class, '');
    	});
        
        $('#save-button').click(function() {
            
            var params = '';
            var required_attrs = [];
            
            // text
            $('.sp-text-field').each(function() {
                var required = $(this).parent().parent().attr('required');
                var value = $(this).val();
                        
                if (required == 'true' && value == '') {
                    required_attrs[required_attrs.length] = $(this).parent().parent().attr('attr-title');
                }
                
                params += 
                    '<input type="hidden" ' + 
                        'name="fld_' + $(this).attr('name') + '" ' + 
                        'value="' + value + '"/>\n';
            });
            
            // checkbox
            $('.sp-checkbox-field').each(function() {
                params += 
                    '<input type="hidden" ' + 
                        'name="fld_' + $(this).attr('name') + '" ' + 
                        'value="' + $(this).attr('checked') + '"/>\n';
            });

            // date
            $('.sp-date-field').each(function() {
                
                var date_value = $(this).datepicker('getDate');
                
                if (date_value != null) {
                    var year = date_value.getFullYear()
                    var month = date_value.getMonth() + 1;
                    var day = date_value.getDate();
                
                    date_value = year + '-' + month + '-' + day;
                }
                else {
                    date_value = '';
                }
                
                var required = $(this).parent().parent().attr('required');
                        
                if (required == 'true' && date_value == '') {
                    required_attrs[required_attrs.length] = $(this).parent().parent().attr('attr-title');
                }
                
                params += 
                    '<input type="hidden" ' + 
                        'name="fld_' + $(this).attr('name') + '" ' + 
                        'value="' + date_value + '"/>\n';
            });
            
            // select fields
            $('.sp-select-field').each(function() {
                
                var required = $(this).parent().parent().attr('required');
                var sel_value = $(this).attr('value');
                        
                if (required == 'true' && sel_value == '') {
                    required_attrs[required_attrs.length] = $(this).parent().parent().attr('attr-title');
                }
                
                params += 
                    '<input type="hidden" ' + 
                        'name="fld_' + $(this).attr('name') + '" ' + 
                        'value="' + sel_value + '"/>\n';
            });
            
            if (required_attrs != '') {
                var alert_msg = "{{_('The following fields must be filled:')}}";
                alert_msg += '<br>';
                for (var i=0; i<required_attrs.length; i++) {
                    alert_msg += 
                        '<p style="margin-left: 20px; ' +
                            'font-size: 10px;' + 
                            'font-weight: bold;">' + 
                        required_attrs[i] + 
                        '</p>';
                }
                
                $('#edit-dialog').
                    html("<p style=''>" + alert_msg + "</p>").
                    dialog({
                    	title: "{{_('Required fields')}}",
                        resizable: false,
                        height: 250,
                        width: 450,
                        modal: true,
                    });
            }
            else {
                $('#edit-form').append(params).submit();
            }
        });
        
        // create datepickers
        // with specific date format and options
        $('.sp-date-field').datepicker({
            firstDay: {{js_options.first_day}},
            changeMonth: true,
            changeYear: true,
            showOn: 'button',
            autoSize: true,
            nextText: "{{_('Next')}}",
            prevText: "{{_('Prev')}}",
            dateFormat: '{{js_options.date_format}}',
            dayNames: ["{{_('Sunday')}}", "{{_('Monday')}}", "{{_('Tuesday')}}",
                       "{{_('Wednesday')}}", "{{_('Thursday')}}", "{{_('Friday')}}",
                       "{{_('Saturday')}}"],
            dayNamesMin: ["{{_('Su')}}", "{{_('Mo')}}", "{{_('Tu')}}", "{{_('We')}}",
                          "{{_('Th')}}", "{{_('Fr')}}", "{{_('Sa')}}"],
            monthNames: ["{{_('January')}}", "{{_('February')}}", "{{_('March')}}", 
                         "{{_('April')}}", "{{_('May')}}", "{{_('June')}}",
                         "{{_('July')}}", "{{_('August')}}", "{{_('September')}}", 
                         "{{_('October')}}", "{{_('November')}}", "{{_('December')}}"]
        });
    });
</script>
{% endblock %}