{% extends 'sapns/base.html' %}
{% import 'sapns/dashboard/util.html' as util %}

{% block head %}
    {{ super() }}
    {{ util.jquery() }}
    {{ util.jquery_ui() }}
    <style type="text/css">
        #edit-user {
            padding: 20px;
        }
        
        .sp-label-field {
            font-size: 14px;
        }
        
        .edit-user-field {
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block middle %}
<div id="user-dialog"></div>
<form id="form-edit-user" method="post" action="/dashboard/users/save">
<input type="hidden" name="id" value="{{user.user_id}}"/>
<div id="edit-user">
    <div class="edit-user-field">
        <div class="sp-label-field">{{_('Display name')}}</div>
        <input class="sp-text-field" type="text" style="width: 50%;" 
            name="display_name" value="{{user.display_name}}"/>
    </div>
    
    <div class="edit-user-field">
        <div class="sp-label-field">{{_('User name')}}</div>
        <input class="sp-text-field" type="text" style="width: 50%;" 
            name="user_name" value="{{user.user_name}}"/>
    </div>

    <div class="edit-user-field">
        <div class="sp-label-field">{{_('E-mail address')}}</div>
        <input class="sp-text-field" type="text" style="width: 50%;" 
            name="email_address" value="{{user.email_address}}"/>
    </div>
    
    <div class="edit-user-field">
        <div class="sp-label-field">{{_('Password')}}</div>
        <input id="password" class="sp-text-field" type="password" 
            name="password" value=""/>
    </div>
    
    <div class="edit-user-field">
        <div class="sp-label-field">{{_('Re-type password')}}</div>
        <input id="password2" class="sp-text-field" type="password" 
            value=""/>
    </div>
    
    {% if not user.user_id %}
    <div>
        <div class="sp-label-field">{{_('Copy from')}}</div>
        <select name="copy_from"></select>
    </div>
    {% endif %}
    
    <div>
        <input id="save_user_btn" type="button" value="{{_('Save')}}"/>
    </div>
</div>
</form>

<script type="text/javascript">
    $(document).ready(function() {
        
        $('.sp-text-field:first').focus();
        
        $('#save_user_btn').click(function() {
            var pswd = $('#password').val();
            var pswd2 = $('#password2').val();
            
            if (pswd != '' && pswd != pswd2) {
                $('#user-dialog').
                    html("<p>{{_('Passwords must be equal')}}</p>").
                    dialog({
                        title: "{{_('User')}}",
                        modal: true,
                        width: 300,
                        height: 100,
                        resizable: false
                    });
            }
            else {
                $('#form-edit-user').submit();
            }
        });
        
        $.ajax({
            url: "{{tg.url('/dashboard/users/all')}}",
            type: "get",
            dataType: "json",
            success: function(res) {
                var options = '';
                for (var i=0; i<res.users.length; i++) {
                    var user = res.users[i];
                    
                    options +=
                        '<option value="' + user.id + '">' +
                           user.display_name + ' [' + user.user_name + ']</option>';
                }
                
                $('select[name=copy_from]').html(options);
            },
            error: function() {
            }
        });
    });
</script>
{% endblock %}