{% extends 'sapns/base.html' %}
{% import 'sapns/dashboard/util.html' as util %}

{% block head %}
    {{ super() }}
    {{ util.jquery() }}
    {{ util.jquery_ui() }}
    <style type="text/css">
        #options {
            position: relative;
            height: 53px;
            border: 1px solid gray;
            background-color: lightgray;
        }
        
        #role_option {
            position: absolute;
            top: 3px;
            left: 20px;
            width: 450px;
            height: 25px;
            padding: 10px;
            border: 1px solid gray;
            background-color: white;
        }
        
        .option_title {
            float: left;
            width: 90px;
            font-weight: bold;
            /*font-family: arial;*/
            font-size: 15px;
        }
        
        #user_option {
            position: absolute;
            top: 3px;
            left: 510px;
            width: 450px;
            height: 25px;
            padding: 10px;
            border: 1px solid gray;
            background-color: white;
        }
        
        #main_pane {
            position: relative;
            height: 400px;
            padding: 10px;
            border: 1px solid gray;
            background-color: white;
        }
        
        #classes_sidebar {
            position: absolute;
            left: 0px;
            top: 0px;
            height: 400px;
            width: 200px;
            border: 1px solid white;
            overflow: auto;
            padding: 10px;
            font-size: 14px;
            /*font-family: Arial;*/
            background-color: lightgray;
        }
        
        .class_row {
            height: 21px;
            border: 1px solid gray;
            padding-left: 10px;
            cursor: pointer;
            background-color: gray;
            margin-bottom: 3px;
        }
        
        .class_row_selected {
            background-color: red;
        }
        
        .class_name {
            font-weight: bold;
            width: 150px;
            float: left;
        }
        
        .class_name:hover {
            text-decoration: underline;
        }
        
        #right_content {
            position: absolute;
            top: 0px;
            left: 224px;
            width: 751px;
            height: 399px;
            padding: 10px;
            border: 1px solid orange; 
        }
        
        #attr_pane {
            position: relative;
            height: 240px;
            /*background-color: cyan;*/
            margin-bottom: 10px;
        }
        
        #attr_title {
            height: 30px;
            padding-left: 10px;
            font-size: 15px;
            background-color: lightgray;
        }
        
        #attr_list {
            overflow: auto;
            height: 210px;
        }
        
        .attr_row {
            heigth: 21px;
            padding-left: 10px;
            margin-bottom: 3px;
            float: left;
            background-color: gray;
            border: 1px solid gray;
        }
        
        .attr_name {
            width: 610px;
            float: left;
        }
        
        #actions_pane {
            position: relative;
            height: 150px;
            overflow: auto;
            /*background-color: gray;*/
        }
        
        #actions_title {
            height: 30px;
            padding-left: 10px;
            font-size: 15px;
            background-color: lightgray;
        }
        
        #actions_list {
            overflow: auto;
            height: 120px;
        }
        
        .action_row {
            heigth: 21px;
            padding-left: 10px;
            margin-bottom: 3px;
            float: left;
            background-color: gray;
            border: 1px solid gray;
        }
        
        .action_name {
            width: 695px;
            float: left;
        }
    </style>
    <script type="text/javascript">
        {% include 'sapns/dashboard/sapns.selector.js' %}
    </script>
{% endblock %}

{% block middle %}
<div id="options">
    <div id="role_option">
        <div class="option_title">{{_('Roles')}}</div>
        <div id="role_selector"></div>
    </div>
    
    <div id="user_option">
        <div class="option_title">{{('Users')}}</div>
        <div id="user_selector"></div>
    </div>
</div>

<div id="main_pane">
    <div id="classes_sidebar">
        {% for i in range(100) %}
        <div id="class_{{i}}" class="class_row" id_class="{{i}}">
            <div class="class_name">{{'Class %d'|format(i)}}</div>
            <input type="checkbox">
        </div>
        {% endfor %}
    </div>
    
    <div id="right_content">
        <div id="attr_pane">
            <div id="attr_title">Attributes</div>
            <div id="attr_list"></div>
        </div>
        
        <div id="actions_pane">
            <div id="actions_title">Actions</div>
            <div id="actions_list"></div>
        </div>
    </div>
    
    <script type="text/javascript">
    
        function get_role_user(data_in) {
            
            var id_role = $('#role_selector').sapnsSelector('getValue');
            var id_user = $('#user_selector').sapnsSelector('getValue');
            
            if (id_role != '') {
                data_in.id_role = id_role;
            }
            else if (id_user != '') {
                data_in.id_user = id_user; 
            }
            else {
                //alert("{{_('Please, select a user or role')}}");
                return false;
            }
            
            return true;
        }
        
        function init_events() {
            
            // attr_access (select) 
            $('.attr_access').change(function() {
                
                var attr_p = $(this).parent();
                
                var data_in = {
                        id_attribute: attr_p.attr('id_attr'),
                        id_attr_p: attr_p.attr('id_attr_p'),
                        access: $(this).val()
                };
                
                /*
                if(!(get_role_user(data_in)) {
                    return;
                }
                */
                data_in.id_role = 1;
                
                console.log(JSON.stringify(data_in));
                
                $.ajax({
                    url: "{{tg.url('/dashboard/privileges/attrp_update')}}",
                    data: data_in,
                    success: function(data) {
                        if (data.status) {
                            attr_p.attr('id_attr_p', data.id_attr_p);
                        }
                    }
                });
            });
                
            // action_granted (checkbox) 
            $('.action_granted').click(function() {
                
                var action_p = $(this).parent();
                
                var data_in = {
                        id_action: action_p.attr('id_action'),
                        id_action_p: action_p.attr('id_action_p')
                };
                
                /*
                if(!(get_role_user(data_in)) {
                    return;
                }
                */
                data_in.id_role = 1;
                
                console.log(JSON.stringify(data_in));
                
                $.ajax({
                    url: "{{tg.url('/dashboard/privileges/actionp_update')}}",
                    data: data_in,
                    success: function(data) {
                        if (data.status) {
                            action_p.attr('id_action_p', data.id_action_p);
                        }
                    }
                });
            });
        }
        
        function load_privileges(id_class) {

            var data_in = {
                    id_class: id_class
            };
            
            data_in.id_class = 55;
            data_in.id_role = 1;
            
            if (true) { //get_role_user(data_in)) {
                // attributes 
                $('#attr_list').html("<p>{{_('Loading')}}...</p>");
                $.ajax({
                    url: "{{tg.url('/dashboard/privileges/attributes')}}",
                    data: data_in, 
                    success: function(data) {
                        $('#attr_list').html(data);
                        init_events();
                    }
                });
                
                // actions 
                $('#actions_list').html("<p>{{_('Loading')}}...</p>");
                $.ajax({
                    url: "{{tg.url('/dashboard/privileges/actions')}}",
                    data: data_in,
                    success: function(data) {
                        $('#actions_list').html(data);
                    }
                });

            }
            else {
                console.log(JSON.stringify(data_in));
            }
        }
    
        $(document).ready(function() {
            
            // role selector 
            $('#role_selector').sapnsSelector({});
            
            // user selector 
            $('#user_selector').sapnsSelector({});
            
            // class name click 
            $('.class_name').click(function() {
                $('.class_row').removeClass('class_row_selected');
                $(this).parent().addClass('class_row_selected');
                
                
                load_privileges($(this).parent().attr('id_class'));
            });
            
            // class checkbox 
            $('.class_row input[type=checkbox]').click(function() {
                
                console.log($(this).parent().attr('id_class') + '=' + $(this).attr('checked'));
                
                var data_in = {
                        id_class: $(this).parent().attr('id_class')
                };
                
                if (get_role_user(data_in)) {
                    $.ajax({
                        url: "{{tg.url('/dashboard/privileges/update_class_privilege')}}",
                        data: data_in,
                        success: function(data) {
                            if (data.status) {
                            }
                        }
                    });
                }
                else {
                    console.log(JSON.stringify(data_in));
                }
            });
        });
    </script>
</div>
{% endblock %}