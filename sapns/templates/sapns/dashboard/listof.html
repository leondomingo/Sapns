{% extends 'sapns/base.html' %}
{% import 'sapns/dashboard/util.html' as util %}

{% block head %}
    {{ super() }}
    <!-- "Sapns - Web Information System: Students" (with caption) -->
    <!-- "Sapns - Web Information System" (without caption) -->
    <!--<title>Sapns - Web Information System{%if grid.caption %}: {{grid.caption}}{%endif%}</title>-->
    {{ util.jquery() }}
    {{ util.jquery_ui() }}
    {{ util.qtip2() }}
{% endblock %}

{% block middle %}
    {{ super() }}
    
    <!--{% if h.predicates.in_group('managers') or h.predicates.has_permission('admin_bar') %}-->
    <div id="sp-admin-bar-show">
        <img title="{{_('Show admin bar')}}" src="{{tg.url('/images/sapns/icons/admin-bar.png')}}">
    </div>
    
    <div id="sp-admin-bar" class="hidden" style="display:none">
        <!--{% for option in admin_bar %}-->
            <!--{% if option.separator %}-->
            <div class="option-separator"></div>
            <!--{% else %}-->
            <div class="option {% if option.required_id %} required_id {% endif %}"
                option-type="{{option.type}}" option-url="{{option.url}}">{{ option.title|escape }}</div>
            <!--{% endif %}-->
        <!--{% endfor %}-->
    </div>
    <!--{% endif %}-->
    
    <div id="grid"></div>
    <!--{% if grid.rel_classes %}-->
    <div id="rel-classes" style="clear:left; padding-left:20px">
        <div class="sp-grid-relatedinfo-title">{{_('Related info')}}</div>
        <select id="rel-classes-sel" style="font-size:11px">
        <!--{% for rc in grid.rel_classes %}-->
        <option cls="{{rc.name}}" ch_attr="{{rc.attr_name}}">{{rc.title}} ({{rc.attr_title}})</option>
        <!--{% endfor %}-->
        </select>
        <button id="rel-classes-show" class="sp-button">{{_('Show')}}</button>
    </div>
    <!--{% endif %}-->

    <script src="{{tg.url('/js/sprintf.min.js')}}"></script>
    <script>
        {% include 'sapns/components/sapns.grid/sapns.grid.min.js' %}
        $(function() {
        	$('.sp-search-txt').focus();
        	var title = $(document).attr('title');
        	$(document).attr('title', sprintf('[%s] %s', "{{grid.caption}}", title));
        	
        	$('#grid').sapnsGrid({
        	    cls: "{{grid.cls}}",
        	    caption: "{{grid.caption}}",
        	    q: "{{grid.q}}", 
        	    rp: "{{grid.rp}}", 
        	    pag_n: "{{grid.pag_n}}",
        	    ch_attr: "{{grid.ch_attr or ''}}",
        	    parent_id: "{{grid.parent_id or ''}}",
        	    actions: {},
        	    url_base: "{{tg.url('/dashboard/list/%s' % grid.cls)}}",
        	    // {% if grid.shift_enabled %} 
        	    shift_enabled: true,
        	    // {% endif %} 
        	    height: 450,
        	    actions_inline: true, 
        	    //hide_id: false,
        	    dblclick: 'edit'
        	});
        	
        	$('#grid .sp-search-txt').focus();
        	
        	$('#rel-classes-show').click(function() {
        	    var ids = $('#grid').sapnsGrid('getSelectedIds');
        	    if (ids.length > 0) {
        	        var opt = $('#rel-classes-sel option:selected');
        	        var cls = opt.attr('cls');
        	        var ch_attr = opt.attr('ch_attr');
        	        var action = "{{tg.url('/dashboard/list/')}}" + cls;
        	        
        	        var form_ = 
        	            '<form id="rel-classes-form" method="get" action="' + action + '" target="_blank">\
        	                <input type="hidden" name="ch_attr" value="' + ch_attr + '">\
        	                <input type="hidden" name="parent_id" value="' + ids[0] + '">\
        	            </form>';
        	            
        	        $(form_).appendTo('body').submit().remove();
        	    }
        	});
        	
        	// {% if h.predicates.in_group('managers') or h.predicates.has_permission('admin_bar') %} 
        	$('#sp-admin-bar-show').click(function() {
        	    $('#sp-admin-bar').fadeToggle();
        	});
        	
        	$('#sp-admin-bar .option').click(function() {
        	    var ids = $('#grid').sapnsGrid('getSelectedIds'),
        	        option_type = $(this).attr('option-type'),
        	        option_url = $(this).attr('option-url'),
        	        option_title = $(this).text(),
        	        dialog_width = 900,
        	        dialog_height = 'auto',
        	        refresh = false;
        	    
        	    if ($(this).hasClass('required_id') && ids.length == 0) {
        	        $('#admin-bar-warning').remove();
        	        $('<div id="admin-bar-warning" style="display:none"></div>').appendTo('body');
        	        $('#admin-bar-warning').html("<p style='text-align:center;font-style:italic'>{{_('You must select a row before click on this action')}}</p>").dialog({
        	            title: option_title,
        	            modal: true,
        	            resizable: false,
        	            width: 600,
        	            height: 155,
        	            buttons: {
        	                "{{_('Close')}}": function() {
        	                    $('#admin-bar-warning').dialog('close');
        	                }
        	            }
        	        });
                }
        	    else {
        	        $('#sp-admin-bar').fadeToggle(function() {
        	            if (option_type === 'reference_order') {
        	                if (!option_url) {
        	                    function_name = 'reference_order';
        	                    dialog_width = 600;
        	                    option_url = "{{tg.url('/dashboard/reference_order/')}}";
        	                }
        	            }
        	            else if (option_type === 'insertion_order') {
        	                if (!option_url) {
        	                    function_name = 'insertion_order';
        	                    dialog_width = 600;
        	                    option_url = "{{tg.url('/dashboard/insertion_order/')}}";
        	                }
        	            }
        	            else if (option_type === 'cascade_delete') {
        	                if (!option_url) {
        	                    function_name = 'cascade_delete';
        	                    dialog_width = 800;
        	                    dialog_height = 230;
        	                    option_url = "{{tg.url('/dashboard/cascade_delete/')}}";
        	                    refresh = true;
        	                }
        	            }
        	            else if (option_type === 'delete_all') {
                            if (!option_url) {
                                function_name = 'delete_all';
                                dialog_width = 800;
                                //dialog_height = '
                                option_url = "{{tg.url('/dashboard/delete_all/')}}";
                                refresh = true;
                            }
                        }
        	            
        	            if (option_url) {
            	            var option_dialog = '<div id="option-dialog" style="display:none"></div>';
            	            $('#option-dialog').remove();
            	            
            	            $(option_dialog).appendTo('body');
            	            
            	            $.ajax({
            	                url: option_url,
            	                data: {
            	                    cls: "{{grid.cls}}",
            	                    ids: JSON.stringify(ids)
            	                },
            	                success: function(content) {
            	                    
            	                    var on_process = false;
            	                    
            	                    $('#option-dialog').html(content).dialog({
            	                        title: sprintf('[%s] %s', "{{grid.caption}}", option_title),
            	                        modal: true,
            	                        resizable: false,
            	                        width: dialog_width,
            	                        height: dialog_height,
            	                        buttons: {
            	                            "{{_('Ok')}}": function() {
            	                                if (!on_process) {
            	                                    on_process = true;
            	                                    window[function_name](function() {
            	                                        $('#option-dialog').dialog('close');
            	                                        
            	                                        if (refresh) {
            	                                            $('#grid').sapnsGrid('search', true);
            	                                        }
            	                                    },
            	                                    function() {
            	                                        on_process = false;
            	                                        alert('Error!');
            	                                    });
            	                                }
            	                            },
            	                            "{{_('Cancel')}}": function() {
            	                                if (!on_process) {
            	                                    $('#option-dialog').dialog('close');
            	                                }
                                            }
            	                        }
            	                    });
            	                }
            	            });
        	            }
        	        });
        	    }
        	});
        	// {% endif %} 
        });
    </script>
{% endblock %}