<!-- {# dialogs (now ain't visible) #} -->
<div id="delete-confirmation" style="display: none;" title="{{_('Delete shortcut')}}">
  <p>{{_('Do you want to delete this shortcut?')}}</p>
  <p id="sp-shortcut-title" style="font-weight: bold;"></p>  
</div>

<div id="bookmark-confirmation" style="display: none;" title="{{_('Send to dashboard')}}">
  <p>{{_('Do you want to send this shortcut to the dashboard?')}}</p>
  <p id="sp-shortcut-title" style="font-weight: bold;"></p>
</div>

<div id="share-dialog" style="display: none;" title="{{_('Shortcut sharing')}}">
    <p>{{_('What user do you want to share this shortcut with?')}}</p>
    <p id="sp-shortcut-title" style="font-weight: bold;"></p>
    <select id="users-to-share-with"></select>
</div>

<form id="order-form" action="" method="post" target="_blank">
    <input type="hidden" name="came_from" />
</form>

<div>
    {% for sc in shortcuts %}
    <div class="sp_shortcut" sc_id="{{sc.id}}" sc_parent="{{sc.parent}}"
        cls="{{sc.cls}}"
        style="{% if loop.index % 2 == 0 %}background-color: white;{% endif %}">
        
        <!--{#
        <div style="float: left;">
            <input type="checkbox"/>
        </div>
        #}-->
        
    {% if sc.action_type %}
        <!-- List -->
        {% if sc.action_type == 'list' %}
        <div class="sp-shortcut-title">
            <a target="_blank" href="{{tg.url('/dashboard/list/%s' % sc.cls)}}">
                {{sc.title}}
            </a>
        </div>
        
        <!-- {# actions over "list" shortcuts #} -->
        <select class="sp-select-shortcut">
        <option value="">{{_('(Select operation)')}}</option>
        
        <!-- {# insertion order #} -->
        <option value="ins-order">{{_('Insertion order')}}</option>
        <!--{#<div class="sp-shortcut-ins-order">
            <a href="{{tg.url('/dashboard/ins_order', params=dict(
                cls=sc.cls, came_from='/dashboard/?sc_parent=%d' % sc.parent))}}">
                {{_('Insertion order')}}
            </a>
        </div>#}-->
        
        <!-- {# reference order #} -->
        <option value="ref-order">{{_('Reference order')}}</option>
        <!--{#<div class="sp-shortcut-ref-order">
            <a href="{{tg.url('/dashboard/ref_order', params=dict(
                cls=sc.cls, came_from='/dashboard/?sc_parent=%d' % sc.parent))}}">
                {{_('Reference order')}}
            </a>
        </div>
        #}-->
        <!-- Process -->
        {% elif sc.action_type == 'process' %}
        <div class="sp-shortcut-title">
            <a href="{{tg.url(sc.url, params=dict(
                cls=sc.cls, came_from=''))}}" target="_blank">
                {{sc.title}}</a>
        </div>
        
        <select class="sp-select-shortcut">
        <option value="">{{_('(Select operation)')}}</option>

        <!--{#<div class="sp-shortcut-ins-order" style="color: gray;">&nbsp;</div>
        <div class="sp-shortcut-ref-order" style="color: gray;">&nbsp;</div>#}-->
        <!-- Object -->
        {% elif sc.action_type == 'object' %}
        <div class="sp-shortcut-title">
            <a target="_blank" href="{{tg.url(sc.url)}}" target="_blank">{{sc.title}}</a>
        </div>
        
        <select class="sp-select-shortcut">
        <option value="">{{_('(Select operation)')}}</option>
        {% else %}
        <div class="sp-shortcut-title">
            <a href="{{tg.url(sc.url)}}">{{sc.title}}</a>
        </div>
        
        <select class="sp-select-shortcut">
        <option value="">{{_('(Select operation)')}}</option>
        {% endif %}
    {% else %}
        <!-- {# This is a group #} -->
        <div class="sp-shortcut-title">
            <a href="{{tg.url('/dashboard', 
                params=dict(sc_parent=sc.id))}}">&lt;{{sc.title}}&gt;</a>
        </div>
        <select class="sp-select-shortcut">
        <option value="">{{_('(Select operation)')}}</option>
        <!--{#<div class="sp-shortcut-ins-order" style="color: gray;">&nbsp;</div>
        <div class="sp-shortcut-ref-order" style="color: gray;">&nbsp;</div>#}-->
    {% endif %}
        <!-- {# general actions over shortcuts #} -->
    
        <!-- {# Edit #} -->
        <option value="edit" 
            title="{{_('Edit this shortcut')}}">{{_('Edit')}}</option>
        <!--{# <div style="float: left;">
            <form method="post" action="/dashboard/sc/edit">
            <input type="hidden" name="id" value="{{sc.id}}"/>
            <input type="hidden" name="came_from" value="{{'/dashboard/?sc_parent=%d' % sc.parent}}"/>
            <input class="sp-button" style="width: 50px; float: left;"
                title="{{_('Edit this shortcut')}}" 
                type="submit" value="{{_('Edit')}}"/>
            </form>
        </div> #}-->
        
        <!-- {# Delete #} -->
        <option value="delete" 
            title="{{_('Remove this shortcut')}}">{{_('Delete')}}</option>
        <!-- {#
        <div style="float: left;">
            <input class="sp-button sc_delete_button" 
                style="width: 50px; float: left;"
                title="{{_('Remove this shortcut')}}" 
                type="button" value="{{_('Delete')}}"/>
        </div>
        #} -->
    
        <!-- {# To dashboard #} -->
        <option value="to-dashboard"
            title="{{_('Put this shortcut on the dashboard')}}">{{_('Send to dashboard')}}</option>
        <!-- {#
        <div style="float: left;">
            <input class="sp-button sc_bookmark_button" 
                style="width: 110px;"
                title="{{_('Put this shortcut on the dashboard')}}"
                type="button" value="{{_('Send to dashboard')}}"/>
        </div>
        #} -->

        <!-- {# Share #} -->
        <option value="share"
            title="{{_('Share this shortcut with another user')}}">{{_('Share')}}</option>
        <!-- {#
        <div>
            <input class="sp-button sc_share_button" 
                style="width: 65px;"
                title=""
                type="button" value="{{_('Share')}}"/>
        </div>
        #}-->
        
        </select>
        
    </div>
    {% endfor %}
</div>

<script type="text/javascript">
    $(document).ready(function() {
    	
    	$('.sp-select-shortcut').change(function() {
    		var opc = $(this).find('option:selected').val();
    		var sc = $(this).parent();
    		if (opc == 'delete') {
    			delete_shortcut(sc);
    		}
    		else if (opc == 'to-dashboard') {
    			sendto_dashboard(sc);
    		}
    		else if (opc == 'share') {
    			share_shortcut(sc);
    		}
    		else if (opc == 'ins-order') {
    			ins_order(sc);
    		}
    		else if (opc == 'ref-order') {
    			ref_order(sc);
    		}
    		
    		$(this).find('option:first').attr('selected', true);
    	});
    	
    	function ins_order(sc) {
    		var cls = sc.attr('cls');
    		$('#order-form').attr('action', "/dashboard/ins_order/" + cls).submit();
    	}
    	
    	function ref_order(sc) {
    		var cls = sc.attr('cls');
    		$('#order-form').attr('action', "/dashboard/ref_order/" + cls).submit();
    	}
        
        // delete 
        function delete_shortcut(sc) {
            var sc_id = sc.attr('sc_id');
            
            var sc_title = sc.find('a').html();
            
            $('#delete-confirmation').find('#sp-shortcut-title').html(sc_title);
            
            $('#delete-confirmation').
            dialog({
                resizable: false,
                height: 200,
                width: 450,
                modal: true,
                buttons: {
                    "{{_('Ok')}}": function() {
                        $.ajax({
                            url: "{{tg.url('/dashboard/sc/delete')}}",
                            type: 'post',
                            dataType: 'json',
                            data: {
                                id: sc_id,
                            },
                            success: function(res) {
                                sc.fadeOut();
                                $('#delete-confirmation').dialog('close');
                            },
                            error: function() {
                                alert('Error!');
                                $('#delete-confirmation').dialog('close');
                            }
                        });
                    },
                    "{{_('Cancel')}}": function() {
                        $('#delete-confirmation').dialog('close');
                    }
                }
            });
        }
        
        // {# bookmark #} 
        function sendto_dashboard(sc) {
            var sc_id = sc.attr('sc_id');
            
            var sc_title = sc.find('a').html();            
            $('#bookmark-confirmation').find('#sp-shortcut-title').html(sc_title);
            
            $('#bookmark-confirmation').dialog({
                resizable: false,
                height: 190,
                width: 500,
                modal: true,
                buttons: {
                    "{{_('Ok')}}": function() { 
                        $.ajax({
                            url: "{{tg.url('/dashboard/sc/bookmark')}}",
                            type: 'post',
                            dataType: 'json',
                            data: {
                                id: sc_id,
                            },
                            success: function(res) {
                                if (res.status) {
                                    sc.effect('highlight', {color: 'red'}, 400);
                                }
                                else {
                                    alert('Error!');
                                }
                                
                                $('#bookmark-confirmation').dialog('close');
                            },
                            error: function() {
                                alert('Error!');
                                $('#bookmark-confirmation').dialog('close');
                            }
                        });
                    },
                    "{{_('Cancel')}}": function() { 
                        $('#bookmark-confirmation').dialog('close');
                    }
                }
            });
        }
        
        // {# share #} 
        function share_shortcut(sc) {
        	
        	// {# load list of users #} 
            $.ajax({
                url: "{{tg.url('/dashboard/users/all')}}",
                type: 'get',
                dataType: 'json',
                success: function(res) {
                    var users = res.users;
                    var options = '';
                    for (var i=0; i<users.length; i++) {
                        options += '<option value="' + users[i].id +'">' + 
                            users[i].display_name + ' [' + users[i].user_name + ']</option>';
                    }
                    
                    $('#users-to-share-with').html(options);
                    
                    // {# "#share-dialog" should be loaded here 
                    // but this way works well also #}  
                },
                error: function() {
                    alert('Error!');
                }
            });        	
        	
            var sc_id = sc.attr('sc_id');
            var sc_title = sc.find('a').html();
            
            $('#share-dialog > #sp-shortcut-title').html(sc_title);
        
            $('#share-dialog').dialog({
                resizable: false,
                height: 230,
                width: 450,
                modal: true,
                buttons: {
                    "{{_('Ok')}}": function() {
                    	
                    	var user_id = $('#users-to-share-with').find('option:selected').val();
                    	
                        $.ajax({
                            url: "{{tg.url('/dashboard/sc/share')}}",
                            type: 'post',
                            dataType: 'json',
                            data: {
                                id_sc: sc_id,
                                id_user: user_id
                            },
                            success: function(res) {
                                if (res.status) {
                                    sc.effect('highlight', {color: 'red'}, 400);
                                }
                                else {
                                    alert('Error!');
                                }
                                
                                $('#users-to-share-with').find('option:first').attr('selected', true);
                                $('#share-dialog').dialog('close');
                            },
                            error: function() {
                                alert('Error!');
                                $('#users-to-share-with').find('option:first').attr('selected', true);
                                $('#share-dialog').dialog('close');
                            }
                        });
                    },
                    "{{_('Cancel')}}": function() {
                    	$('#users-to-share-with').find('option:first').attr('selected', true);
                        $('#share-dialog').dialog('close');
                    }
                }
            });
        }
    });
</script>
