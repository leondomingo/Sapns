{% extends 'sapns/base.html' %}
{% import 'sapns/dashboard/util.html' as util %}

{% block head %}
    {{ super() }}
    {{ util.jquery() }}
    {{ util.jquery_ui() }}
    {{ util.jquery_jstree() }}
{% endblock %}

{% block middle %}
<!-- {# dialogs (now ain't visible) #} -->
<div id="delete-confirmation" style="display:none" title="{{_('Delete shortcut')}}">
  <p>{{_('Do you want to delete this shortcut?')}}</p>
  <p id="sp-shortcut-title" style="font-weight:bold"></p>  
</div>

<div id="sp-exploration-head">
    <!--{% if this_shortcut.id %}-->
    <span class="title">{{this_shortcut.title}}</span>
    <!--{% endif %}-->
    
    <div id="sp-shortcut-order" class="button" title="{{_('Order')}}"><img src="{{tg.url('/images/sapns/icons/order.png')}}"></div>
    <div id="sp-shortcut-new" class="button" title="{{_('New')}}"><img src="{{tg.url('/images/sapns/icons/new.png')}}"></div>
    <!--{% if (sc_parent or '') != '' %}-->
    <a class="sp-shortcut-up button" href="{{tg.url('/dashboard/data_exploration/', params=dict(sc_parent=sc_parent))}}" title="{{_('up')}}">
        <img src="{{tg.url('/images/sapns/icons/north.png')}}">
    </a>
    <!--{% endif %}-->
</div>

<div id="sp-shortcut-list"></div>

<div id="sp-shortcut-options" class="caja3d" style="display:none">
    <div class="option edit">{{_('Edit')}}</div>
    <div class="option users">{{_('Users')}}</div>
    <div class="option roles">{{_('Roles')}}</div>
    <!--{% if sc_parent %}-->
    <div class="option up">{{_('Up')}}</div>
    <!--{% else %}-->
    <div class="option up-disabled">{{_('Up')}}</div>
    <!--{% endif %}-->
    <div class="option delete">{{_('Delete')}}</div>
</div>

<script src="{{tg.url('/js/sidebar-messages.min.js', params=dict(v=1))}}"></script>
<script>
    $(function() {
        
        var sbm = new SidebarMessages(),
            order_mode = false;
        
        function load_shortcuts() {
            $.ajax({
                url: "{{tg.url('/dashboard/sc/list_/')}}",
                data: {
                    id_user: "{{tg.request.identity['user'].user_id}}",
                    sc_parent: "{{this_shortcut.id or ''}}"
                },
                success: function(content) {
                    $('#sp-shortcut-list').html(content).removeClass('order-mode');
                    
                    if (!order_mode) {
                        $('.sp-shortcut').draggable({
                            helper: 'clone',
                            start: function() {
                                $('#sp-shortcut-list').addClass('on-dragging');
                                $('#sp-shortcut-options').slideDown();
                            },
                            stop: function() {
                                $('#sp-shortcut-options').slideUp(function() {
                                    $('#sp-shortcut-list').removeClass('on-dragging');
                                });
                            }
                        });
                        
                        $('.sp_sidebar').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'activo',
                            drop: function(e, ui) {
                                $.ajax({
                                    url: "{{tg.url('/dashboard/sc/bookmark/')}}",
                                    data: { id_shortcut: ui.draggable.attr('shortcut_id') },
                                    success: function(res) {
                                        if (res.status) {
                                            var new_shortcut = '<div class="item_sb item_sb_sortable" shortcut_id="' + res.shortcut.id + '">\
                                                <a href="' + res.shortcut.url + '">\
                                                <span class="text_sb" title="' + res.shortcut.title + '">' + res.shortcut.title + '</span>\
                                                </a></div>' 
                                            
                                            $('.sp_sidebar').append(new_shortcut);
                                        }
                                    },
                                    error: function() {
                                    }
                                });
                            }
                        });
                        
                        $('.sp-shortcut.group').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'activo',
                            drop: function(e, ui) {
                                var id_group = $(this).attr('shortcut_id');
                                $.ajax({
                                    url: "{{tg.url('/dashboard/sc/move/')}}",
                                    data: {
                                        id_shortcut: ui.draggable.attr('shortcut_id'),
                                        id_group: id_group
                                    },
                                    success: function(res) {
                                        if (res.status) {
                                            ui.draggable.fadeOut(function() {
                                                ui.draggable.remove();
                                            });
                                        }
                                        else {
                                            // Error 
                                        }
                                    }
                                });
                            }
                        });
                        
                        $('#sp-shortcut-options .edit').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'accept',
                            drop: function(e, ui) {
                                var shortcut_id = ui.draggable.attr('shortcut_id');
                                edit_shortcut(shortcut_id);
                            }
                        });
                        
                        $('#sp-shortcut-options .users').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'accept',
                            drop: function(e, ui) {
                                var action_type = ui.draggable.attr('action_type');
                                var cls;
                                if (action_type === 'list') {
                                    console.log(action_type + ' ' + cls);
                                }
                                else {
                                    console.log(action_type);
                                }
                            }
                        });
                        
                        $('#sp-shortcut-options .roles').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'accept',
                            drop: function(e, ui) {
                                var action_type = ui.draggable.attr('action_type');
                                var cls;
                                if (action_type === 'list') {
                                    console.log(action_type + ' ' + cls);
                                }
                                else {
                                    console.log(action_type);
                                }
                            }
                        });
                        
                        $('#sp-shortcut-options .up').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'accept',
                            drop: function(e, ui) {
                                $.ajax({
                                    url: "{{tg.url('/dashboard/sc/move/')}}",
                                    data: {
                                        id_shortcut: ui.draggable.attr('shortcut_id'),
                                        id_group: "{{sc_parent}}"
                                    },
                                    success: function(res) {
                                        if (res.status) {
                                            ui.draggable.fadeOut(function() {
                                                ui.draggable.remove();
                                            });
                                        }
                                        else {
                                            // Error 
                                        }
                                    }
                                });
                            }
                        });
                        
                        $('#sp-shortcut-options .delete').droppable({
                            accept: '.sp-shortcut',
                            hoverClass: 'accept',
                            drop: function(e, ui) {
                                var shortcut_id = ui.draggable.attr('shortcut_id');
                                var action_type = ui.draggable.attr('action_type');
                                var cls = ui.draggable.attr('cls');
                                
                                $('#delete-confirmation').dialog({
                                    modal: true,
                                    resizable: false,
                                    width: 450,
                                    buttons: {
                                        "{{_('Ok')}}": function() {
                                            $.ajax({
                                                url: "{{tg.url('/dashboard/sc/delete/')}}",
                                                data: { id_shortcut: shortcut_id },
                                                success: function(res) {
                                                    if (res.status) {
                                                        $('#delete-confirmation').dialog('close');
                                                        // delete shortcut (right pane) 
                                                        ui.draggable.fadeOut();
                                                        
                                                        // delete shortcut from sidebar (left pane), if it exists 
                                                        $('.sp_sidebar').find('div[shortcut_id=' + shortcut_id + ']').fadeOut();
                                                    }
                                                },
                                                error: function() {
                                                    alert('Error!');
                                                    $('#delete-confirmation').dialog('close');
                                                }
                                            });
                                        },
                                        "{{_('Cancel')}}": function() {
                                            $('#delete-confirmation').dialog('close');
                                        }
                                    }
                                });
                            }
                        });
                        
                        $('.sp-select-shortcut').change(function() {
                            var opc = $(this).find('option:selected').val();
                            var sc = $(this).parent();
                            if (opc == 'delete') {
                                delete_shortcut(sc);
                            }
                            else if (opc == 'to-dashboard') {
                                sendto_dashboard(sc);
                            }
                            else if (opc == 'share') {
                                share_shortcut(sc);
                            }
                            else if (opc == 'ins-order') {
                                ins_order(sc);
                            }
                            else if (opc == 'ref-order') {
                                ref_order(sc);
                            }
                            else if (opc == 'up' || opc == 'down') {
                                move_shortcut(sc, opc);
                            }
                            
                            $(this).find('option:first').prop('selected', true);
                        });
                    }
                    else {
                        $('#sp-shortcut-list').addClass('order-mode').sortable({
                            stop: function() {
                                var order = [];
                                $('#sp-shortcut-list .sp-shortcut').each(function() {
                                    order.push($(this).attr('shortcut_id')*1);
                                });
                                
                                $.ajax({
                                    url: "{{tg.url('/dashboard/sc/reorder/')}}",
                                    data: { order: JSON.stringify(order) },
                                    success: function(res) {
                                        if (!res.status) {
                                            $('#sp-shortcut-list').sortable('cancel');
                                        }
                                    },
                                    error: function() {
                                        $('#sp-shortcut-list').sortable('cancel');
                                    }
                                });
                            }
                        });
                    }
                }
            });
        }
        
        load_shortcuts();
        
        function edit_shortcut(id_shortcut) {
            var en_proceso = false;
            var id_mensaje = sbm.show({ message: "{{_('Wait, please')}}...", hide_after: 0 });
            
            $.ajax({
                url: "{{tg.url('/dashboard/sc/edit/')}}",
                data: { id_shortcut: id_shortcut, id_parent: "{{this_shortcut.id or ''}}" },
                success: function(content) {
                    sbm.hide({ id: id_mensaje, velocity: 1500 });
                    
                    $('#sp-shortcut-new-dialog').remove();
                    $('<div id="sp-shortcut-new-dialog" style="display:none"></div>').appendTo('body');
                    $('#sp-shortcut-new-dialog').html(content).dialog({
                        title: "{{_('New shortcut')}}",
                        modal: true,
                        resizable: false,
                        width: 700,
                        height: 'auto',
                        buttons: {
                            "{{_('Ok')}}": function() {
                                if (!en_proceso) {
                                    en_proceso = true;
                                    sp_shortcut_new(function(res) {
                                        $('#sp-shortcut-new-dialog').dialog('close');
                                        load_shortcuts();
                                    },
                                    function() {
                                        en_proceso = false;
                                    });
                                }
                            },
                            "{{_('Cancel')}}": function() {
                                if (!en_proceso) {
                                    $('#sp-shortcut-new-dialog').dialog('close');
                                }
                            }
                        }
                    });
                },
                error: function() {
                    sbm.hide({ id: id_mensaje, velocity: 1500 });
                }
            });
        }
        
        $('#sp-shortcut-new').click(function() {
            edit_shortcut();
        });
        
        $('#sp-shortcut-order').click(function() {
            order_mode = !order_mode;
            load_shortcuts();
        });
        
        var s_ = '.sp-no-shortcuts span.here'; 
        $(document).off('click', s_).on('click', s_, function() {
            edit_shortcut();
        });
    	
        // share 
        function share_shortcut(sc) {
        	
        	// load list of users 
            $.ajax({
                url: "{{tg.url('/dashboard/users/all_')}}",
                type: 'get',
                dataType: 'json',
                success: function(res) {
                    var users = res.users;
                    var options = '';
                    for (var i=0; i<users.length; i++) {
                        options += '<option value="' + users[i].id +'">' + 
                            users[i].display_name + ' [' + users[i].user_name + ']</option>';
                    }
                    
                    $('#users-to-share-with').html(options);
                    
                    // {# "#share-dialog" should be loaded here 
                    // but this way works well also #}  
                },
                error: function() {
                    alert('Error!');
                }
            });        	
        	
            var sc_id = sc.attr('sc_id');
            var sc_title = sc.find('a').html();
            
            $('#share-dialog > #sp-shortcut-title').html(sc_title);
        
            $('#share-dialog').dialog({
                resizable: false,
                height: 230,
                width: 450,
                modal: true,
                buttons: {
                    "{{_('Ok')}}": function() {
                    	
                    	var user_id = $('#users-to-share-with').val();
                    	
                        $.ajax({
                            url: "{{tg.url('/dashboard/sc/share')}}",
                            type: 'post',
                            dataType: 'json',
                            data: {
                                id_sc: sc_id,
                                id_user: user_id
                            },
                            success: function(res) {
                                if (res.status) {
                                    sc.effect('highlight', {color: 'red'}, 400);
                                }
                                else {
                                    alert('Error!');
                                }
                                
                                $('#users-to-share-with option:first').prop('selected', true);
                                $('#share-dialog').dialog('close');
                            },
                            error: function() {
                                alert('Error!');
                                $('#users-to-share-with option:first').prop('selected', true);
                                $('#share-dialog').dialog('close');
                            }
                        });
                    },
                    "{{_('Cancel')}}": function() {
                    	$('#users-to-share-with').find('option:first').prop('selected', true);
                        $('#share-dialog').dialog('close');
                    }
                }
            });
        }
    });
</script>
{% endblock %}