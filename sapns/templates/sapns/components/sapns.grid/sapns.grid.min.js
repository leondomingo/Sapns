<<<<<<< HEAD
function load_script(src){var fileref=document.createElement("script");fileref.setAttribute("type","text/javascript");
fileref.setAttribute("src",src);document.getElementsByTagName("head")[0].appendChild(fileref)
}function load_css(href){var fileref=document.createElement("link");fileref.setAttribute("rel","stylesheet");
fileref.setAttribute("type","text/css");fileref.setAttribute("href",href)}try{sprintf
}catch(e){load_script("{{tg.url('/js/sprintf.min.js')}}")}(function($){function SapnsGrid(settings){function set(this_object,key,value,obj){if(obj==undefined){obj=settings
}if(obj[key]==undefined){this_object[key]=value}else{this_object[key]=obj[key]}return
}set(this,"caption","");if(typeof(this.caption)=="function"){this.caption=this.caption()
}set(this,"name","grid_"+Math.floor(Math.random()*999999));set(this,"cls","");set(this,"with_search",true);
set(this,"search_params",{});set(this,"show_ids",false);set(this,"link","");set(this,"q","");
set(this,"ch_attr","");set(this,"parent_id","");set(this,"cols",[]);set(this,"data",{});
set(this,"height",500);set(this,"url_base","");set(this,"multiselect",false);set(this,"actions_inline",false);
set(this,"hide_id",false);set(this,"dblclick",null);set(this,"select_first",false);
set(this,"onLoad",null);set(this,"default_",{});set(this.default_,"col_width",60,this.default_);
set(this.default_,"col_align","center",this.default_);set(this.default_,"empty_value","",this.default_);
set(this,"actions",null);if(typeof(this.actions)=="function"){this.actions=this.actions()
}set(this,"exportable",true);var formats=[{id:"csv",title:"CSV",url:"{{tg.url('/dashboard/tocsv')}}"},{id:"excel",title:"Excel",url:"{{tg.url('/dashboard/toxls')}}"}];
set(this,"exportable_formats",formats);set(this,"with_pager",true);set(this,"pag_n",1);
set(this,"rp",10);set(this,"this_page",0);set(this,"total_count",0);set(this,"total_pag",0);
this.ajx_data="{}"}SapnsGrid.prototype.getSelectedIds=function(){var self=this;var selected_ids=[];
$("#"+self.name+" .sp-grid-row").each(function(){var rowid=$(this).find(".sp-grid-rowid");
if(rowid.attr("checked")==true){selected_ids.push(rowid.attr("id_row")*1)}});return selected_ids
};SapnsGrid.prototype.getAction=function(action_name){var self=this;for(var i=0,l=self.actions.length;
i<l;i++){var act=self.actions[i];if(typeof(act.type)=="object"){if(act.type.id==action_name){return act
}}else{if(act.name==action_name){return act}}}};SapnsGrid.prototype.getRow=function(id){var self=this;
var row=null;$("#"+self.name+" .sp-grid-row").each(function(){var rowid=$(this).find(".sp-grid-rowid");
if(rowid.attr("id_row")==id){row=rowid.parent();return}});return row};SapnsGrid.prototype.loadData=function(){var self=this;
var g_table='<table class="sp-grid"><tr><td class="sp-col-title">#</td>';if(self.actions_inline){g_table+='<td class="sp-col-title">*</td>'
}var cols=self.cols;if(typeof(cols)=="function"){cols=cols()}for(var i=0,l=cols.length;
i<l;i++){var col=cols[i];var wd=col.width;if(!wd){wd=self.default_.col_width}if(self.hide_id&&col.title=="id"){continue
}g_table+=sprintf('<td class="sp-col-title" style="width: %(wd)dpx;">%(title)s</td>',{wd:wd,title:col.title})
}g_table+="</tr>";var data=self.data;if(typeof(data)=="function"){data=data()}var ld=data.length;
if(ld>0){for(var i=0;i<ld;i++){var row=data[i];g_table+='<tr class="sp-grid-row"><td title="'+(i+1)+'"><input class="sp-grid-rowid" type="checkbox" id_row="'+row[0]+'"></td>';
if(self.actions_inline){var actions_wd="width: 100px;";var _action_style='style="padding: 2px; margin-left: 5px; margin-right: 5px; border: 1px solid lightgray;"';
var _actions='<td style="font-size: 10px;"><div style="%(actions_wd)s"><img class="inline_action edit_inline" title="{{_("Edit")}}" src="{{tg.url("/images/sapns/icons/edit.png")}}"><img class="inline_action delete_inline" title="{{_("Delete")}}" src="{{tg.url("/images/sapns/icons/delete.png")}}"><img class="inline_action docs_inline" title="{{_("Docs")}}" src="{{tg.url("/images/sapns/icons/docs.png")}}">';
var nonstd="";var la=self.actions.length;if(la>0){for(var a=0;a<la;a++){var act=self.actions[a];
if((act.type==="process"||typeof(act.type)=="object")&&act.require_id){if(typeof(act.type)=="object"){nonstd+=sprintf('<option value="%(id)s">%(title)s</option>',{id:act.type.id,title:act.title})
}else{nonstd+=sprintf('<option value="%(name)s">%(title)s</option>',{name:act.name,title:act.title})
}}}}if(nonstd){nonstd='<select class="nonstd_actions"><option value=""></option>'+nonstd+"</select>"
}else{actions_wd="width: 75px;"}g_table+=sprintf(_actions,{actions_wd:actions_wd})+nonstd;
g_table+="</div></td>"}for(var j=0,lr=cols.length;j<lr;j++){var col=cols[j];var al=col.align;
if(!al){al=self.default_.col_align}var wd=col.width;if(!wd){wd=self.default_.col_width
}var cell=row[j];if(!cell){cell=self.default_.empty_value}if(self.hide_id&&col.title=="id"){continue
}var width="";if(wd>0){width=sprintf(" width: %(wd)d px;",{wd:wd})}g_table+=sprintf('<td><div class="sp-grid-cell" style="text-align: %(al)s; %(wd)s"',{al:al,wd:width});
if(cell){g_table+='title="'+cell+'"'}else{g_table+='title="({{_("empty")}})"'}g_table+='clickable="true">'+cell+"</div></td>"
}g_table+="</tr>"}}else{var n=1;if(self.actions_inline){n=3}g_table+='<tr class="sp-grid-row" style="width: 100%; height: '+(self.height-50)+'px;"><td class="sp-grid-cell sp-grid-noresults" colspan="'+(cols.length+n)+'">{{_("No results")}}</td></tr>'
}$("#"+self.name).find(".sp-grid-parent").html(g_table);if(self.select_first&&self.with_search&&self.q&&ld<5&&ld>0){$("#"+self.name+" .sp-grid-row input[type=checkbox]:first").attr("checked",true)
}};SapnsGrid.prototype.search=function(q,force,on_load){var self=this;if(force==undefined){force=false
}if(q==undefined){q=self.q}if(self.q!=q||force){self.pag_n=1}self.q=q;var loading='<div style="padding: 10px; font-size: 15px; '+sprintf('font-weight: bold; color: gray; height: %(hg)dpx;">{{_("Loading")}}...</div>',{hg:self.height-50});
$("#"+self.name).find(".sp-grid-parent").html(loading);var ajx=$.extend(true,{url:"{{tg.url('/dashboard/grid/')}}",data:{cls:self.cls,q:self.q,rp:self.rp,pag_n:self.pag_n,ch_attr:self.ch_attr,parent_id:self.parent_id},success:function(response){if(response.status){if(response.this_page){self.this_page=response.this_page
}if(response.total_count){self.total_count=response.total_count}if(response.total_pag){self.total_pag=response.total_pag
}if(response.cols){self.cols=response.cols}if(response.actions){self.actions=response.actions
}var pos=(self.pag_n-1)*self.rp*1;var params={curr_page:self.pag_n*1,total_page:self.total_pag*1,pos0:pos+1,pos1:pos+self.this_page};
var pag_desc=sprintf("{{_('Page %(curr_page)d of %(total_page)d / Showing rows %(pos0)d to %(pos1)d')}}",params);
$("#"+self.name+" .first-page").attr("title","{{_('page 1')}}");if(params.curr_page>1){var prev_page=sprintf("{{_('page %(p)d')}}",{p:params.curr_page-1});
$("#"+self.name+" .page-back").attr("title",prev_page).attr("disabled",false)}else{$("#"+self.name+" .page-back").attr("disabled",true)
}if(params.curr_page<params.total_page){var next_page=sprintf("{{_('page %(p)d')}}",{p:params.curr_page+1});
$("#"+self.name+" .page-forth").attr("title",next_page).attr("disabled",false)}else{$("#"+self.name+" .page-forth").attr("disabled",true)
}var last_page=sprintf("{{_('page %(p)d')}}",{p:params.total_page});$("#"+self.name+" .last-page").attr("title",last_page);
$("#"+self.name+" .sp-grid-pager-desc").html(pag_desc);$("#"+self.name+" .sp-grid-current-page").val(self.pag_n);
try{$(".sp-grid-cell").qtip({content:{text:true},position:{my:"left top",at:"bottom center"},style:"ui-tooltip-dark ui-tooltip-rounded"})
}catch(e){}self.data=response.data;self.loadData();if(on_load){on_load(response)}if(self.onLoad){self.onLoad(response)
}}}},self.search_params);var curr_ajx_data=JSON.stringify(ajx.data);if(self.ajx_data){if(self.ajx_data===curr_ajx_data&&!force){self.loadData()
}else{$.ajax(ajx)}}self.ajx_data=curr_ajx_data};SapnsGrid.prototype.warningSelectedId=function(){var self=this;
$("#grid-dialog_"+self.name).html("<p style='text-align: center; font-style: italic;'>{{_('You must select a row before click on this action')}}</p>").dialog({title:self.caption,resizable:false,height:155,width:450,modal:true,draggable:false,buttons:{"{{_('Close')}}":function(){$("#grid-dialog_"+self.name).dialog("close")
}}});$(".ui-icon-closethick").hide()};SapnsGrid.prototype._loadActions=function(actions){var self=this;
var g_actions="";if(actions.length>0){g_actions="";for(var i=0,l=actions.length;i<l;
i++){var act=actions[i];var req_id=act.require_id;if(req_id===undefined){req_id=true
}if(typeof(act.type)==="string"){var a='<div style="float: left;">';a+='<button class="sp-button sp-grid-action standard_action"  id="'+self.name+"_"+act.name+'" title="'+act.url+'" url="'+act.url+'" action-type="'+act.type+'" require_id="'+req_id+'" >'+act.title+"</button></div>";
if(act.type==="new"){var new_btn='<img class="inline_action new_inline" title="{{_("New")}}" src="{{tg.url("/images/sapns/icons/new.png")}}">';
$("#search_box").append(new_btn)}else{if(self.actions_inline&&(act.type=="edit"||act.type=="delete"||act.type=="docs")){continue
}}}}}if(self.exportable){var formats=self.exportable_formats;if(typeof(self.exportable)=="object"){formats=self.exportable.formats
}var l=formats.length;if(l>0){var options="";for(var i=0;i<l;i++){options+='<option value="'+formats[i].id+'">'+formats[i].title+"</option>"
}var s_export='<div id="grid-export_'+self.name+'" style="height: 25px; float: left;"><select id="select-export" class="sp-button sp-grid-action" style="height: 20px;"><option value="">({{_("Export")}})</option>'+options+"</select></div>";
$("#search_box").append(s_export)}}return g_actions};SapnsGrid.prototype.loadActions=function(){var self=this;
var g_actions="";if(self.actions!=null){if(self.actions.length===undefined){var ajx=$.extend(true,{url:"{{tg.url('/dashboard/grid_actions/')}}",type:"post",data:{cls:self.cls},success:function(response){if(response.status){self.actions=response.actions
}$("#"+self.name+" .actions").html(self._loadActions(self.actions))}},self.actions);
$.ajax(ajx)}else{$("#"+self.name+" .actions").html(self._loadActions(self.actions));
for(var a=0,la=self.actions.length;a<la;a++){var act=self.actions[a];if(typeof(act.type)=="object"&&!act.require_id){$("#"+self.name+" .actions").show();
$("#"+self.name+" .actions").append(sprintf('<button id="%(id)s" class="below_actions" style="font-size: 11px; min-width: 80px;">%(title)s</button>',{id:act.type.id,title:act.title}))
}}$(".below_actions").live("click",function(){var act=self.getAction($(this).attr("id"));
if(act.require_id){var selected_ids=self.getSelectedIds();if(selected_ids.length>0){act.type.f(selected_ids[0],selected_ids)
}else{self.warningSelectedId()}}else{var selected_ids=self.getSelectedIds();if(selected_ids.length>0){act.type.f(selected_ids[0],selected_ids)
}else{act.type.f()}}})}}$("#"+self.name+" .sp-grid-cell").live("click",function(event){if($(this).attr("clickable")=="true"){var row_id=$(this).parent().parent().find(".sp-grid-rowid");
$("#"+self.name+" .sp-grid-rowid").each(function(){var ctrl=event.ctrlKey||event.metaKey;
if($(this)!=row_id&&!self.multiselect&&!ctrl){$(this).attr("checked",false)}});if(row_id.attr("checked")==true){row_id.attr("checked",false)
}else{row_id.attr("checked",true)}}});function form(action,target){var came_from="";
if(target!="_blank"){var came_from=self.url_base+"?q="+encodeURI(self.q).replace("-","%2D","g").replace('"',"%22","g").replace("+","%2B","g").replace("#","%23","g")+"&rp="+self.rp+"&pag_n="+self.pag_n+"&ch_attr="+self.ch_attr+"&parent_id="+self.parent_id
}var f='<form type="post" action="'+action+'" target="'+target+'"><input type="hidden" name="came_from" value="'+came_from+'">';
if(self.ch_attr){f+='<input type="hidden" name="_'+self.ch_attr+'" value="'+self.parent_id+'">'
}f+="</form>";return f}function run_action(item,action_name,ctrl){var act=self.getAction(action_name);
var id=item.parent().parent().parent().find(".sp-grid-rowid").attr("id_row");if(typeof(act.type)!="object"){var a=act.url;
if(a[a.length-1]!="/"){a+="/"}var target="";if(ctrl){target="_blank"}if(act.type=="process"){a+=id
}else{if(act.type=="new"){a+=sprintf("%s/",self.cls)}else{a+=sprintf("%s/%s",self.cls,id)
}}$(form(a,target)).appendTo("body").submit().remove()}else{act.type.f(id)}}$("#"+self.name+" .new_inline").live("click",function(event){run_action($(this),"new",event.ctrlKey||event.metaKey)
});$("#"+self.name+" .edit_inline").live("click",function(event){run_action($(this),"edit",event.ctrlKey||event.metaKey)
});$("#"+self.name+" .delete_inline").live("click",function(event){var id=$(this).parent().parent().parent().find(".sp-grid-rowid").attr("id_row");
var act=self.getAction("delete");self.std_delete([id],act.url)});$("#"+self.name+" .docs_inline").live("click",function(event){run_action($(this),"docs")
});$("#"+self.name+" .nonstd_actions").live("change",function(event){var action_id=$(this).val();
if(action_id){run_action($(this),action_id)}});$("#grid-export_"+self.name).live("change",function(){var fmt=$("#grid-export_"+self.name+" option:selected").val();
if(fmt==""){return}var formats=self.exportable_formats;var extra_params="";if(typeof(self.exportable)=="object"){formats=self.exportable.formats;
if(self.exportable.data){for(k in self.exportable.data){var v=self.exportable.data[k];
if(typeof(v)=="function"){v=v()}extra_params+='<input type="hidden" name="'+k+'" value="'+v+'">'
}}}var url="";for(var i=0,l=formats.length;i<l;i++){if(formats[i].id==fmt){url=formats[i].url;
break}}var form_export='<form action="'+url+'" method="get" ><input type="hidden" name="cls" value="'+self.cls+'"><input type="hidden" name="q" value="'+self.q+'"><input type="hidden" name="ch_attr" value="'+self.ch_attr+'"><input type="hidden" name="parent_id" value="'+self.parent_id+'">'+extra_params+"</form>";
$(form_export).appendTo("body").submit().remove();$(this).find("option:first").attr("selected",true)
})};SapnsGrid.prototype.std_delete=function(ids,url){var self=this;var cls=self.cls;
var id=JSON.stringify(ids);var delete_html="<p id='delete-question'>{{_('Do you really want to delete this record?')}}</p><p id='object-title'></p>";
var error_html="<p id='delete-error-title'>{{_('Oops, something went wrong...')}}</p><div id='delete-error-message'></div>";
$("#grid-dialog_"+self.name).html(delete_html);var title="";$.ajax({url:"{{tg.url('/dashboard/title')}}",type:"get",dataType:"json",data:{cls:cls,id:id},success:function(res){if(res.status){var title;
if(typeof(res.title)=="string"){title=res.title}else{title=res.title.join(" | ")}$("#grid-dialog_"+self.name+" #object-title").html(title)
}},error:function(){}});$("#grid-dialog_"+self.name).dialog({width:650,height:210,resizable:false,modal:true,title:"{{_('Delete')}}",buttons:{"{{_('Ok')}}":function(){$.ajax({url:url,type:"get",dataType:"json",data:{cls:cls,id_:id},success:function(res){if(res.status){self.search(self.q,true);
$("#grid-dialog_"+self.name).dialog("close")}else{$("#grid-dialog_"+self.name).dialog("close");
var message="<p style='color: gray;'>"+res.message+"</p>";if(res.rel_tables!=undefined&&res.rel_tables.length>0){message+="<div>{{_('For your information this object is related with other objects in the following classes:')}}</div>";
message+="<ul>";for(var i=0;i<res.rel_tables.length;i++){var title=res.rel_tables[i].class_title;
var attr_title=res.rel_tables[i].attr_title;message+='<li><span style="font-weight: bold;">'+title+'</span> (<span style="color: gray;">'+attr_title+"</span>)</li>"
}message+="</ul>"}$("#grid-dialog_"+self.name).html(error_html).find("#delete-error-message").html(message);
$("#grid-dialog_"+self.name).dialog({width:700,height:250,buttons:{"{{_('Close')}}":function(){$("#grid-dialog_"+self.name).dialog("close")
}}})}},error:function(){$("#grid-dialog_"+self.name).dialog("close");$("#grid-dialog_"+self.name).html(error_html).dialog({buttons:{"{{_('Close')}}":function(){$("#grid-dialog_"+self.name).dialog("close")
}}})}})},"{{_('Cancel')}}":function(){$("#grid-dialog_"+self.name).dialog("close")
}}})};$.fn.sapnsGrid=function(arg1,arg2,arg3){if(typeof(arg1)=="object"){var g=new SapnsGrid(arg1);
this.data("sapnsGrid",g);this.append(sprintf('<div id="grid-dialog_%(name)s" style="display: none;"></div>',{name:g.name}));
var g_content="";g_content+=sprintf('<div class="sp-grid-container" id="%(name)s" cls="%(cls)s">',{name:g.name,cls:g.cls});
if(g.caption){g_content+=sprintf('<div class="sp-grid-caption">%(caption)s</div>',{caption:g.caption})
}if(g.with_search){g_content+='<div><div id="search_box" style="float: left;"><input class="sp-search-txt" style="float: left;" name="q" type="text" value=""><img class="inline_action sp-search-btn" src="{{tg.url("/images/sapns/icons/search.png")}}" title="{{_("Search...")}}" style="margin-left: 5px;"></div>';
$("#"+g.name+" .sp-search-btn").live("click",function(){g.search($("#"+g.name+" .sp-search-txt").val())
});$("#"+g.name+" .sp-search-txt").live("keypress",function(event){if(event.which==13){g.search($(this).val())
}});if(g.link){g_content+="<div style=\"padding-left: 20px;\"><button id='link-shortcut' class='sp-button' style='float: left;'>{{_('Create a shortcut')}}</button><div style=\"font-size: 9px; margin-top: 7px; width: 100px; float: left;\"><a id='this-search' href='"+g.link+"' target='_blank'>[{{_('this search')}}]</a></div><div id=\"link-shortcut-dialog\" style=\"display: none;\"><p>{{_('Do you want to create a shortcut for this search?')}}</p><label>{{_('Shortcut title')}}:</label><input id='link-shortcut-title' type='text' value='({{_('title')}})'></div></div>"
}g_content+="</div>"}var g_table=sprintf('<div class="sp-grid-parent" style="overflow: auto; clear: left; height: %(hg)dpx; background-color: transparent;"></div>',{hg:g.height});
var g_pager="";if(g.with_pager){g_pager+='<div class="sp-grid-pager"><div class="sp-grid-pager-desc"></div>';
var sel_10="",sel_50="",sel_100="",sel_all="";var sel=" selected";var another_value="";
if(g.rp==10){sel_10=sel}else{if(g.rp==50){sel_50=sel}else{if(g.rp==100){sel_100=sel
}else{if(g.rp==0){sel_all=sel}else{another_value='<option value="'+g.rp+'" selected>'+g.rp+"</option>"
}}}}g_pager+='<div style="float: left; clear: right; height: 25px; margin-top: 2px;"><select class="sp-button sp-grid-rp">'+another_value+'<option value="10"'+sel_10+'>10</option><option value="50"'+sel_50+'>50</option><option value="100"'+sel_100+'>100</option><option value="0"'+sel_all+'>{{_("All")}}</option></select><button class="sp-button first-page" style="float: left;">|&lt;&lt;</button><button class="sp-button page-back" style="float: left;">&lt;&lt;</button><input class="sp-grid-current-page" type="text" style="text-align: center; font-size: 11px; margin-top: 3px;" readonly><button class="sp-button page-forth" style="float: left;">&gt;&gt</button><button class="sp-button last-page" style="float: left;">&gt;&gt|</button></div>';
g_pager+="</div>";$("#"+g.name+" .sp-grid-rp").live("change",function(){g.rp=$(this).val();
g.pag_n=1;g.search(g.q)});$("#"+g.name+" .first-page").live("click",function(){g.pag_n=1;
g.search(g.q)});$("#"+g.name+" .page-back").live("click",function(){if(g.pag_n>1){g.pag_n-=1;
g.search(g.q)}});$("#"+g.name+" .page-forth").live("click",function(){if(g.pag_n<g.total_pag){g.pag_n*=1;
g.pag_n+=1;g.search(g.q)}});$("#"+g.name+" .last-page").live("click",function(){g.pag_n=g.total_pag;
g.search(g.q)})}var g_actions='<div class="actions" style="padding: 2px; height: 25px; display: none;"></div>';
this.append(g_content+g_table+g_actions+g_pager+"</div>");g.loadActions();$("#"+g.name+" .sp-search-txt").val(g.q);
g.search(g.q)}else{if(typeof(arg1)=="string"){var self=this.data("sapnsGrid");if(arg1=="loadData"){self.loadData()
}else{if(arg1=="search"){var q="";if(typeof(arg2)=="boolean"){q=self.q}else{if(arg2){q=arg2
}}if(self.with_search){$("#"+self.name+" .sp-search-txt").val(q)}self.search(q,true,arg3)
}else{if(arg1=="getSelectedIds"){return self.getSelectedIds()}else{if(arg1=="setRp"){self.rp=arg2;
$("#"+self.name+" .sp-grid-rp [value="+arg2+"]").attr("selected",true)}}}}}}return this
=======
function load_script(b){var a=document.createElement("script");a.setAttribute("type","text/javascript");
a.setAttribute("src",b);document.getElementsByTagName("head")[0].appendChild(a)}function load_css(a){var b=document.createElement("link");
b.setAttribute("rel","stylesheet");b.setAttribute("type","text/css");b.setAttribute("href",a)
}(function(b){function a(d){function e(f,g,h,i){if(i==undefined){i=d}if(i[g]==undefined){f[g]=h
}else{f[g]=i[g]}return}e(this,"caption","");if(typeof(this.caption)=="function"){this.caption=this.caption()
}e(this,"name","grid_"+Math.floor(Math.random()*999999));e(this,"cls","");e(this,"with_search",true);
e(this,"search_params",{});e(this,"show_ids",false);e(this,"link","");e(this,"q","");
e(this,"ch_attr","");e(this,"parent_id","");e(this,"cols",[]);e(this,"data",{});e(this,"height",500);
e(this,"url_base","");e(this,"multiselect",false);e(this,"actions_inline",false);
e(this,"hide_check",false);e(this,"hide_id",false);e(this,"dblclick",null);e(this,"select_first",false);
e(this,"onLoad",null);e(this,"default_",{});e(this.default_,"col_width",60,this.default_);
e(this.default_,"col_align","center",this.default_);e(this.default_,"empty_value","",this.default_);
e(this,"actions",null);if(typeof(this.actions)=="function"){this.actions=this.actions()
}e(this,"exportable",true);var c=[{id:"csv",title:"CSV",url:"{{tg.url('/dashboard/tocsv')}}"},{id:"excel",title:"Excel",url:"{{tg.url('/dashboard/toxls')}}"}];
e(this,"exportable_formats",c);e(this,"with_pager",true);e(this,"pag_n",1);e(this,"rp",10);
e(this,"this_page",0);e(this,"total_count",0);e(this,"total_pag",0);this.ajx_data="{}"
}a.prototype.getSelectedIds=function(){var c=this;var d=[];b("#"+c.name+" .sp-grid-row").each(function(){var e=b(this).find(".sp-grid-rowid");
if(e.attr("checked")==true){d.push(e.attr("id_row")*1)}});return d};a.prototype.getRow=function(e){var c=this;
var d=null;b("#"+c.name+" .sp-grid-row").each(function(){var f=b(this).find(".sp-grid-rowid");
if(f.attr("id_row")==e){d=f.parent();return}});return d};a.prototype.loadData=function(){var p=this;
var o=p.cols;if(typeof(o)=="function"){o=o()}var e=20;for(var w=0,t=o.length;w<t;
w++){var d=o[w];e+=(d.width+8)}var x='<div class="sp-grid" style="width: '+e+'px;">';
if(!p.hide_check){x+='<div class="sp-grid-row"><div class="sp-col-title">#</div>'
}if(p.actions_inline){x+='<div class="sp-col-title">*</div>'}for(var w=0,t=o.length;
w<t;w++){var d=o[w];var m=d.width;if(!m){m=p.default_.col_width}if(p.hide_id&&d.title=="id"){continue
}x+='<div class="sp-col-title" style="width: '+m+'px;">'+d.title+"</div>"}x+="</div>";
var y=p.data;if(typeof(y)=="function"){y=y()}var q=y.length;if(q>0){for(var w=0;w<q;
w++){var f=y[w];x+='<div class="sp-grid-row">';if(!p.hide_check){x+='<div class="sp-grid-cell" title="'+(w+1)+'"><input class="sp-grid-rowid" type="checkbox" id_row="'+f[0]+'"></div>'
}if(p.actions_inline){var g='style="padding: 2px; margin-left: 5px; margin-right: 5px; border: 1px solid lightgray;"';
x+='<div class="sp-grid-cell" style="font-size: 10px; width: 35px;"><a class="edit_inline" href="#" title="edit" '+g+'>E</a><a class="delete_inline" href="#" title="delete" '+g+'>D</a><a class="docs_inline" href="#" title="docs" '+g+">D</a></div>"
}for(var v=0,h=o.length;v<h;v++){var d=o[v];var u=d.align;if(!u){u=p.default_.col_align
}var m=d.width;if(!m){m=p.default_.col_width}var c=f[v];if(!c){c=p.default_.empty_value
}if(p.hide_id&&d.title=="id"){continue}var s="";if(m>0){s=" width: "+m+"px;"}x+='<div class="sp-grid-cell" style="text-align: '+u+";"+s+'"';
if(c){x+='title="'+c.replace(/"/gi,"''")+'"'}else{x+='title="({{_("empty")}})"'}x+='clickable="true">'+c+"</div>"
}x+="</div>"}}else{var r=1;if(p.actions_inline){r=3}x+='<div class="sp-grid-row"><div class="sp-grid-cell sp-grid-noresults" style="width: '+(e-o.length*4)+'px;" >{{_("No results")}}</div></div>'
}x+="</div>";b("#"+p.name).find(".sp-grid-parent").html(x);if(p.select_first&&p.with_search&&p.q&&q<5&&q>0){b("#"+p.name+" .sp-grid-row input[type=checkbox]:first").attr("checked",true)
}};a.prototype.search=function(h,g,f){var e=this;if(g==undefined){g=false}if(h==undefined){h=e.q
}if(e.q!=h||g){e.pag_n=1}e.q=h;var i='<div style="padding: 10px; font-size: 15px; font-weight: bold; color: gray;">{{_("Loading")}}...</div>';
b("#"+e.name).find(".sp-grid-parent").html(i);var d=b.extend(true,{url:"{{tg.url('/dashboard/grid/')}}",data:{cls:e.cls,q:e.q,rp:e.rp,pag_n:e.pag_n,ch_attr:e.ch_attr,parent_id:e.parent_id},success:function(l){if(l.status){if(l.this_page){e.this_page=l.this_page
}if(l.total_count){e.total_count=l.total_count}if(l.total_pag){e.total_pag=l.total_pag
}if(l.cols){e.cols=l.cols}if(l.actions){e.actions=l.actions}var r=(e.pag_n-1)*e.rp*1;
var q={curr_page:e.pag_n*1,total_page:e.total_pag*1,pos0:r+1,pos1:r+e.this_page};
var n=sprintf("{{_('Page %(curr_page)d of %(total_page)d / Showing rows %(pos0)d to %(pos1)d')}}",q);
b("#"+e.name+" .first-page").attr("title","{{_('page 1')}}");if(q.curr_page>1){var j=sprintf("{{_('page %(p)d')}}",{p:q.curr_page-1});
b("#"+e.name+" .page-back").attr("title",j).attr("disabled",false)}else{b("#"+e.name+" .page-back").attr("disabled",true)
}if(q.curr_page<q.total_page){var o=sprintf("{{_('page %(p)d')}}",{p:q.curr_page+1});
b("#"+e.name+" .page-forth").attr("title",o).attr("disabled",false)}else{b("#"+e.name+" .page-forth").attr("disabled",true)
}var m=sprintf("{{_('page %(p)d')}}",{p:q.total_page});b("#"+e.name+" .last-page").attr("title",m);
b("#"+e.name+" .sp-grid-pager-desc").html(n);b("#"+e.name+" .sp-grid-current-page").val(e.pag_n);
try{b(".sp-grid-cell").qtip({content:{text:true},position:{my:"left top",at:"bottom center"},style:"ui-tooltip-dark ui-tooltip-rounded"})
}catch(p){}e.data=l.data;e.loadData();if(f){f(l)}if(e.onLoad){e.onLoad(l)}}}},e.search_params);
var c=JSON.stringify(d.data);if(e.ajx_data){if(e.ajx_data===c&&!g){e.loadData()}else{b.ajax(d)
}}e.ajx_data=c};a.prototype.warningSelectedId=function(){var c=this;b("#grid-dialog_"+c.name).html("<p style='text-align: center; font-style: italic;'>{{_('You must select a row before click on this action')}}</p>").dialog({title:c.caption,resizable:false,height:155,width:450,modal:true,draggable:false,buttons:{"{{_('Close')}}":function(){b("#grid-dialog_"+c.name).dialog("close")
}}});b(".ui-icon-closethick").hide()};a.prototype._loadActions=function(d){var n=this;
var j="";if(d.length>0){j="";for(var e=0,c=d.length;e<c;e++){var g=d[e];var f=g.require_id;
if(f===undefined){f=true}if(typeof(g.type)==="string"){var m='<div style="float: left;">';
m+='<button class="sp-button sp-grid-action standard_action"  id="'+n.name+"_"+g.name+'" title="'+g.url+'" url="'+g.url+'" action-type="'+g.type+'" require_id="'+f+'" >'+g.title+"</button></div>";
if(g.type==="new"){b("#search_box").append(m)}else{j+=m}}else{j+='<div style="float: left;"><button id="'+g.type.id+'" class="sp-button sp-grid-action"  require_id="'+f+'" >'+g.title+"</button></div>"
}}}if(n.exportable){var h=n.exportable_formats;if(typeof(n.exportable)=="object"){h=n.exportable.formats
}var c=h.length;if(c>0){var o="";for(var e=0;e<c;e++){o+='<option value="'+h[e].id+'">'+h[e].title+"</option>"
}j+='<div id="grid-export_'+n.name+'" style="position: absolute; background-color: none; height: 25px; right: 0px;"><select id="select-export" class="sp-button sp-grid-action" style="height: 20px;"><option value="">({{_("Export")}})</option>'+o+"</select></div>"
}}return j};a.prototype.loadActions=function(){var g=this;var f="";if(g.actions!=null){if(g.actions.length===undefined){var c=b.extend(true,{url:"{{tg.url('/dashboard/grid_actions/')}}",type:"post",data:{cls:g.cls},success:function(i){if(i.status){g.actions=i.actions
}b("#"+g.name+" .actions").html(g._loadActions(g.actions))}},g.actions);b.ajax(c)
}else{b("#"+g.name+" .actions").html(g._loadActions(g.actions));if(g.actions.length==0&&!g.exportable){b("#"+g.name+" .actions").css("min-height","0px")
}for(var h=0,e=g.actions.length;h<e;h++){var d=g.actions[h];if(typeof(d.type)=="object"){b("#"+d.type.id).data("_func",d.type.f);
b("#"+d.type.id).live("click",function(){if(b(this).attr("require_id")=="true"){var i=g.getSelectedIds();
if(i.length>0){b(this).data("_func")(i[0],i)}else{g.warningSelectedId()}}else{var i=g.getSelectedIds();
if(i.length>0){b(this).data("_func")(i[0],i)}else{b(this).data("_func")()}}})}}}}b("#"+g.name+" .sp-grid-cell").live("click",function(j){if(b(this).attr("clickable")=="true"){var i=b(this).parent().find(".sp-grid-rowid");
b("#"+g.name+" .sp-grid-rowid").each(function(){var l=j.ctrlKey||j.metaKey;if(b(this)!=i&&!g.multiselect&&!l){b(this).attr("checked",false)
}});if(i.attr("checked")==true){i.attr("checked",false)}else{i.attr("checked",true)
}}});b("#"+g.name+" .standard_action").live("click",function(j){function n(x,y){var i="";
if(y!="_blank"){var i=g.url_base+"?q="+encodeURI(g.q).replace("-","%2D","g").replace('"',"%22","g").replace("+","%2B","g").replace("#","%23","g")+"&rp="+g.rp+"&pag_n="+g.pag_n+"&ch_attr="+g.ch_attr+"&parent_id="+g.parent_id
}var l='<form type="post" action="'+x+'" target="'+y+'"><input type="hidden" name="came_from" value="'+i+'">';
if(g.ch_attr){l+='<input type="hidden" name="_'+g.ch_attr+'" value="'+g.parent_id+'">'
}l+="</form>";return l}var w=g.ch_attr;var s="";if(j.ctrlKey||j.metaKey){s="_blank"
}var m=b(this).attr("url");var u=b(this).attr("action-type");var v=b(this).attr("_func");
if(!v){var t=b(this).attr("url");if(t[t.length-1]!="/"){t+="/"}var p=g.getSelectedIds();
if(b(this).attr("require_id")=="true"){if(p.length>0){if(u=="delete"){g.std_delete(p,m)
}else{if(u=="process"){if(p.length==1){t+=p[0];b(n(t,s)).appendTo("body").submit().remove()
}else{var o=t;for(var r=0,q=p.length;r<q;r++){b(n(o+p[r],"_blank")).appendTo("body").submit().remove()
}}}else{if(p.length==1){t+=sprintf("%s/%s",g.cls,p[0]+"");b(n(t,s)).appendTo("body").submit().remove()
}else{t+=sprintf("%s/",g.cls);var o=t;for(var r=0,q=p.length;r<q;r++){b(n(o+p[r],"_blank")).appendTo("body").submit().remove()
}}}}}else{g.warningSelectedId()}}else{if(u=="new"){t+=sprintf("%s/",g.cls);b(n(t,s)).appendTo("body").submit().remove()
}else{if(u=="process"){if(p.length==1){t+=sprintf("%s/",p[0]+"");b(n(t,s)).appendTo("body").submit().remove()
}else{if(p.length>1){var o=t;for(var r=0,q=p.length;r<q;r++){b(n(o+p[r],"_blank")).appendTo("body").submit().remove()
}}else{b(n(t,s)).appendTo("body").submit().remove()}}}}}}else{v()}});b("#grid-export_"+g.name).live("change",function(){var n=b("#grid-export_"+g.name+" option:selected").val();
if(n==""){return}var j=g.exportable_formats;var s="";if(typeof(g.exportable)=="object"){j=g.exportable.formats;
if(g.exportable.data){for(k in g.exportable.data){var o=g.exportable.data[k];if(typeof(o)=="function"){o=o()
}s+='<input type="hidden" name="'+k+'" value="'+o+'">'}}}var q="";for(var r=0,m=j.length;
r<m;r++){if(j[r].id==n){q=j[r].url;break}}var p='<form action="'+q+'" method="get" ><input type="hidden" name="cls" value="'+g.cls+'"><input type="hidden" name="q" value="'+g.q+'"><input type="hidden" name="ch_attr" value="'+g.ch_attr+'"><input type="hidden" name="parent_id" value="'+g.parent_id+'">'+s+"</form>";
b(p).appendTo("body").submit().remove();b(this).find("option:first").attr("selected",true)
})};a.prototype.std_delete=function(g,f){var e=this;var d=e.cls;var j=JSON.stringify(g);
var h="<p id='delete-question'>{{_('Do you really want to delete this record?')}}</p><p id='object-title'></p>";
var c="<p id='delete-error-title'>{{_('Oops, something went wrong...')}}</p><div id='delete-error-message'></div>";
b("#grid-dialog_"+e.name).html(h);var i="";b.ajax({url:"{{tg.url('/dashboard/title')}}",type:"get",dataType:"json",data:{cls:d,id:j},success:function(l){if(l.status){var m;
if(typeof(l.title)=="string"){m=l.title}else{m=l.title.join(" | ")}b("#grid-dialog_"+e.name+" #object-title").html(m)
}},error:function(){}});b("#grid-dialog_"+e.name).dialog({width:650,height:210,resizable:false,modal:true,title:"{{_('Delete')}}",buttons:{"{{_('Ok')}}":function(){b.ajax({url:f,type:"get",dataType:"json",data:{cls:d,id_:j},success:function(m){if(m.status){e.search(e.q,true);
b("#grid-dialog_"+e.name).dialog("close")}else{b("#grid-dialog_"+e.name).dialog("close");
var n="<p style='color: gray;'>"+m.message+"</p>";if(m.rel_tables!=undefined&&m.rel_tables.length>0){n+="<div>{{_('For your information this object is related with other objects in the following classes:')}}</div>";
n+="<ul>";for(var l=0;l<m.rel_tables.length;l++){var p=m.rel_tables[l].class_title;
var o=m.rel_tables[l].attr_title;n+='<li><span style="font-weight: bold;">'+p+'</span> (<span style="color: gray;">'+o+"</span>)</li>"
}n+="</ul>"}b("#grid-dialog_"+e.name).html(c).find("#delete-error-message").html(n);
b("#grid-dialog_"+e.name).dialog({width:700,height:250,buttons:{"{{_('Close')}}":function(){b("#grid-dialog_"+e.name).dialog("close")
}}})}},error:function(){b("#grid-dialog_"+e.name).dialog("close");b("#grid-dialog_"+e.name).html(c).dialog({buttons:{"{{_('Close')}}":function(){b("#grid-dialog_"+e.name).dialog("close")
}}})}})},"{{_('Cancel')}}":function(){b("#grid-dialog_"+e.name).dialog("close")}}})
};b.fn.sapnsGrid=function(m,i,h){if(typeof(m)=="object"){var l=new a(m);this.data("sapnsGrid",l);
this.append('<div id="grid-dialog_'+l.name+'" style="display: none;"></div>');var t="";
t+='<div class="sp-grid-container" id="'+l.name+'" cls="'+l.cls+'">';if(l.caption){t+='<div class="sp-grid-caption">'+l.caption+"</div>"
}if(l.with_search){t+='<div><div id="search_box" style="float: left;"><input class="sp-search-txt" style="float: left;" name="q" type="text" value=""><button class="sp-button sp-search-btn" style="float: left;">{{_("Search...")}}</button></div>';
b("#"+l.name+" .sp-search-btn").live("click",function(){l.search(b("#"+l.name+" .sp-search-txt").val())
});b("#"+l.name+" .sp-search-txt").live("keypress",function(g){if(g.which==13){l.search(b(this).val())
}});if(l.link){t+="<div style=\"padding-left: 20px;\"><button id='link-shortcut' class='sp-button' style='float: left;'>{{_('Create a shortcut')}}</button><div style=\"font-size: 9px; margin-top: 7px; width: 100px; float: left;\"><a id='this-search' href='"+l.link+"' target='_blank'>[{{_('this search')}}]</a></div><div id=\"link-shortcut-dialog\" style=\"display: none;\"><p>{{_('Do you want to create a shortcut for this search?')}}</p><label>{{_('Shortcut title')}}:</label><input id='link-shortcut-title' type='text' value='({{_('title')}})'></div></div>"
}t+="</div>"}var o='<div class="sp-grid-parent" style="overflow: auto; clear: left; height: '+(l.height+5)+'px; background-color: transparent;"></div>';
var e="";if(l.with_pager){e+='<div class="sp-grid-pager">';e+='<div class="sp-grid-pager-desc"></div>';
var n="",f="",s="",p="";var d=" selected";var j="";if(l.rp==10){n=d}else{if(l.rp==50){f=d
}else{if(l.rp==100){s=d}else{if(l.rp==0){p=d}else{j='<option value="'+l.rp+'" selected>'+l.rp+"</option>"
}}}}e+='<select class="sp-button sp-grid-rp">'+j+'<option value="10"'+n+'>10</option><option value="50"'+f+'>50</option><option value="100"'+s+'>100</option><option value="0"'+p+'>{{_("All")}}</option></select><button class="sp-button first-page" style="float: left;">|&lt;&lt;</button><button class="sp-button page-back" style="float: left;">&lt;&lt;</button><div><input class="sp-grid-current-page" type="text" style="text-align: center;" readonly></div><button class="sp-button page-forth" style="float: left;">&gt;&gt</button><button class="sp-button last-page" style="float: left;">&gt;&gt|</button>';
e+="</div>";b("#"+l.name+" .sp-grid-rp").live("change",function(){l.rp=b(this).val();
l.pag_n=1;l.search(l.q)});b("#"+l.name+" .first-page").live("click",function(){l.pag_n=1;
l.search(l.q)});b("#"+l.name+" .page-back").live("click",function(){if(l.pag_n>1){l.pag_n-=1;
l.search(l.q)}});b("#"+l.name+" .page-forth").live("click",function(){if(l.pag_n<l.total_pag){l.pag_n*=1;
l.pag_n+=1;l.search(l.q)}});b("#"+l.name+" .last-page").live("click",function(){l.pag_n=l.total_pag;
l.search(l.q)})}this.append(t+'<div class="actions" style="clear: left; position: relative; min-height: 20px;"></div>'+o+e+"</div>");
l.loadActions();b("#"+l.name+" .sp-search-txt").val(l.q);l.search(l.q)}else{if(typeof(m)=="string"){var r=this.data("sapnsGrid");
if(m=="loadData"){r.loadData()}else{if(m=="search"){var c="";if(typeof(i)=="boolean"){c=r.q
}else{if(i){c=i}}if(r.with_search){b("#"+r.name+" .sp-search-txt").val(c)}r.search(c,true,h)
}else{if(m=="getSelectedIds"){return r.getSelectedIds()}else{if(m=="setRp"){r.rp=i;
b("#"+r.name+" .sp-grid-rp [value="+i+"]").attr("selected",true)}}}}}}return this
>>>>>>> sapns_grid_divs
}})(jQuery);