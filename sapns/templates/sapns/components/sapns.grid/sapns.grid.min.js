(function(b){function a(d){function e(f,g,h,i){if(i==undefined){i=d}if(i[g]==undefined){f[g]=h
}else{f[g]=i[g]}return}e(this,"caption","");if(typeof(this.caption)=="function"){this.caption=this.caption()
}e(this,"name","grid_"+Math.floor(Math.random()*999999));e(this,"cls","");e(this,"with_search",true);
e(this,"search_params",{});e(this,"show_ids",false);e(this,"link","");e(this,"q","");
e(this,"ch_attr","");e(this,"parent_id","");e(this,"cols",[]);e(this,"data",{});e(this,"height",500);
e(this,"url_base","");e(this,"multiselect",false);e(this,"actions_inline",false);
e(this,"hide_check",false);e(this,"hide_id",false);e(this,"dblclick",null);e(this,"select_first",false);
e(this,"onLoad",null);e(this,"default_",{});e(this.default_,"col_width",60,this.default_);
e(this.default_,"col_align","center",this.default_);e(this.default_,"empty_value","",this.default_);
e(this,"actions",null);if(typeof(this.actions)=="function"){this.actions=this.actions()
}e(this,"_new_default",{name:"new",url:"/dashboard/new/",require_id:"false",type:"new"});
e(this,"_edit_default",{name:"edit",url:"/dashboard/edit/",require_id:"true",type:"edit"});
e(this,"_delete_default",{name:"delete",url:"/dashboard/delete/",require_id:"true",type:"delete"});
e(this,"_docs_default",{name:"docs",url:"/dashboard/docs/",require_id:"true",type:"docs"});
e(this,"exportable",true);var c=[{id:"csv",title:"CSV",url:"{{tg.url('/dashboard/tocsv')}}"},{id:"excel",title:"Excel",url:"{{tg.url('/dashboard/toxls')}}"}];
e(this,"exportable_formats",c);e(this,"with_pager",true);e(this,"pag_n",1);e(this,"rp",10);
e(this,"this_page",0);e(this,"total_count",0);e(this,"total_pag",0);this.ajx_data="{}"
}a.prototype.getSelectedIds=function(){var c=this;var d=[];b("#"+c.name+" .sp-grid-row").each(function(){var e=b(this).find(".sp-grid-rowid");
if(e.attr("checked")==true){d.push(e.attr("id_row")*1)}});return d};a.prototype.getAction=function(g){var e=this;
for(var f=0,d=e.actions.length;f<d;f++){var c=e.actions[f];if(typeof(c.type)=="object"){if(c.type.id==g){return c
}}else{if(c.name==g){return c}}}};a.prototype.getRow=function(e){var c=this;var d=null;
b("#"+c.name+" .sp-grid-row").each(function(){var f=b(this).find(".sp-grid-rowid");
if(f.attr("id_row")==e){d=f.parent();return}});return d};a.prototype.loadData=function(){var s=this;
var r=s.cols;if(typeof(r)=="function"){r=r()}var h=23;if(s.hide_check){h=-6}for(var A=0,w=r.length;
A<w;A++){var g=r[A];if(s.hide_id&&g.title=="id"){continue}h+=(g.width+5)}var B='<div class="sp-grid" style="width: '+(h+5)+'px;">';
var d='<div class="sp-grid-row">';if(!s.hide_check){d+='<div class="sp-col-title" style="width: 23px;"><input class="sp-grid-select-all" type="checkbox"/></div>'
}if(s.actions_inline){d+='<div class="sp-col-title" style="%(actions_wd)s">*</div>'
}for(var A=0,w=r.length;A<w;A++){var g=r[A];var q=g.width;if(!q){q=s.default_.col_width
}if(s.hide_id&&g.title=="id"){continue}d+='<div class="sp-col-title" style="width: '+q+'px;">'+g.title+"</div>\n"
}d+="</div>";var E=s.data;if(typeof(E)=="function"){E=E()}var t=E.length;if(t>0){for(var A=0;
A<t;A++){var m=E[A];var f='<div class="sp-grid-row">\n';if(!s.hide_check){var z="";
if(A==t-1){z="border-radius: 0 0 0 5px;"}f+='<div class="sp-grid-cell" title="'+(A+1)+'" style="width: 23px;'+z+'"><input class="sp-grid-rowid" type="checkbox" id_row="'+m[0]+'"></div>'
}if(s.actions_inline){var c="width: 100px;";if(!s.nonstd){c="width: 75px;"}var p='style="padding: 2px; margin-left: 5px; margin-right: 5px; border: 1px solid lightgray;"';
var D='<div class="sp-grid-cell" style="%(actions_wd)s">\n<img class="inline_action edit_inline" title="{{_("Edit")}}" src="{{tg.url("/images/sapns/icons/edit.png")}}">\n<img class="inline_action delete_inline" title="{{_("Delete")}}" src="{{tg.url("/images/sapns/icons/delete.png")}}">\n<img class="inline_action docs_inline" title="{{_("Docs")}}" src="{{tg.url("/images/sapns/icons/docs.png")}}">\n';
f+=sprintf(D,{actions_wd:c})+s.nonstd+"\n";f+="</div>\n"}if(A==0){B+=sprintf(d,{actions_wd:c})
}for(var y=0,o=r.length;y<o;y++){var g=r[y];var x=g.align;if(!x){x=s.default_.col_align
}var q=g.width;if(!q){q=s.default_.col_width}var e=m[y];if(!e){e=s.default_.empty_value
}if(s.hide_id&&g.title=="id"){continue}var v="";if(q>0){v=" width: "+q+"px;"}var z="";
if((s.hide_check&&A==t-1)&&(!s.hide_id&&y==0||s.hide_id&&y==1)){z="border-radius: 0 0 0 5px;"
}if(A==t-1&&y==o-1){z="border-radius: 0 0 5px 0;"}f+='<div class="sp-grid-cell" style="text-align: '+x+";"+v+z+'"';
if(e){f+='title="'+e.replace(/"/gi,"''")+'"'}else{f+='title="({{_("empty")}})"'}f+='clickable="true">'+e+"</div>\n"
}f+="</div>\n";B+=f}}else{var u=1;var C=h;if(s.actions_inline){u=3;C+=25}B+=sprintf(d,{actions_wd:c})+'<div class="sp-grid-row"><div class="sp-grid-cell sp-grid-noresults" title="{{_("No results")}}" style="width: '+C+'px;" >{{_("No results")}}</div></div>'
}B+="</div>";b("#"+s.name).find(".sp-grid-parent").html(B);if(s.select_first&&s.with_search&&s.q&&t<5&&t>0){b("#"+s.name+" .sp-grid-rowid:first").attr("checked",true)
}};a.prototype.search=function(h,g,f){var e=this;if(g==undefined){g=false}if(h==undefined){h=e.q
}if(e.q!=h||g){e.pag_n=1}e.q=h;var i='<div style="padding: 10px; font-size: 15px; '+sprintf('font-weight: bold; color: gray; height: %(hg)dpx;">{{_("Loading")}}...</div>',{hg:e.height-50});
b("#"+e.name).find(".sp-grid-parent").html(i);var d=b.extend(true,{url:"{{tg.url('/dashboard/grid/')}}",data:{cls:e.cls,q:e.q,rp:e.rp,pag_n:e.pag_n,ch_attr:e.ch_attr,parent_id:e.parent_id},success:function(l){if(l.status){if(l.this_page){e.this_page=l.this_page
}if(l.total_count){e.total_count=l.total_count}if(l.total_pag){e.total_pag=l.total_pag
}if(l.cols){e.cols=l.cols}if(l.actions){e.actions=l.actions}var r=(e.pag_n-1)*e.rp*1;
var q={curr_page:e.pag_n*1,total_page:e.total_pag*1,pos0:r+1,pos1:r+e.this_page};
var n=sprintf("{{_('Page %(curr_page)d of %(total_page)d / Showing rows %(pos0)d to %(pos1)d')}}",q);
b("#"+e.name+" .sp-grid-first-page").attr("title","{{_('page 1')}}");if(q.curr_page>1){var j=sprintf("{{_('page %(p)d')}}",{p:q.curr_page-1});
b("#"+e.name+" .sp-grid-page-back").attr("title",j).attr("disabled",false)}else{b("#"+e.name+" .sp-grid-page-back").attr("disabled",true)
}if(q.curr_page<q.total_page){var o=sprintf("{{_('page %(p)d')}}",{p:q.curr_page+1});
b("#"+e.name+" .sp-grid-page-forth").attr("title",o).attr("disabled",false)}else{b("#"+e.name+" .sp-grid-page-forth").attr("disabled",true)
}var m=sprintf("{{_('page %(p)d')}}",{p:q.total_page});b("#"+e.name+" .sp-grid-last-page").attr("title",m);
b("#"+e.name+" .sp-grid-pager-desc").html(n);b("#"+e.name+" .sp-grid-current-page").val(e.pag_n);
try{b(".sp-grid-cell").qtip({content:{text:true},position:{my:"left top",at:"bottom center"},style:"ui-tooltip-dark ui-tooltip-rounded"})
}catch(p){}e.data=l.data;e.loadData();if(f){f(l)}if(e.onLoad){e.onLoad(l)}}}},e.search_params);
var c=JSON.stringify(d.data);if(e.ajx_data){if(e.ajx_data===c&&!g){e.loadData()}else{b.ajax(d)
}}e.ajx_data=c};a.prototype.warningSelectedId=function(){var c=this;b("#grid-dialog_"+c.name).html("<p style='text-align: center; font-style: italic;'>{{_('You must select a row before click on this action')}}</p>").dialog({title:c.caption,resizable:false,height:155,width:450,modal:true,draggable:false,buttons:{"{{_('Close')}}":function(){b("#grid-dialog_"+c.name).dialog("close")
}}});b(".ui-icon-closethick").hide()};a.prototype._loadActions=function(e){var r=this;
var p="";r.nonstd="";var j='<button id="%(id)s" class="sp-grid-button-action">%(title)s</button>';
var q='<option value="%(id)s">%(title)s</option>';if(e.length>0){p="";for(var f=0,c=e.length;
f<c;f++){var n=e[f];var g=n.require_id;if(g===undefined){g=true}if(typeof(n.type)==="string"&&n.type==="new"){var m='<img class="inline_action new_inline" title="{{_("New")}}" src="{{tg.url("/images/sapns/icons/new.png")}}">';
b("#"+r.name+" .sp-grid-search-box").append(m)}else{if(!r.actions_inline){b("#"+r.name+" .sp-grid-button-actions").show();
var t;if(typeof(n.type)=="object"){t={id:n.type.id,title:n.title}}else{t={id:n.name,title:n.title}
}b("#"+r.name+" .sp-grid-button-actions").append(sprintf(j,t))}else{if(r.actions_inline){if(typeof(n.type)==="string"&&(n.type=="edit"||n.type=="delete"||n.type=="docs")){continue
}else{var d;if(typeof(n.type)=="object"){d={id:n.type.id,title:n.title}}else{d={id:n.name,title:n.title}
}r.nonstd+=sprintf(q,d)}}}}}if(r.nonstd){r.nonstd='<select class="nonstd_actions">\n<option value=""></option>\n'+r.nonstd+"</select>\n"
}}if(r.exportable){var o=r.exportable_formats;if(typeof(r.exportable)=="object"){o=r.exportable.formats
}var c=o.length;if(c>0){var s="";for(var f=0;f<c;f++){s+='<option value="'+o[f].id+'">'+o[f].title+"</option>"
}var h='<div id="grid-export_'+r.name+'" style="height: 25px; float: left;"><select id="select-export" class="sp-button sp-grid-action" style="height: 20px;"><option value="">({{_("Export")}})</option>'+s+"</select></div>";
b("#"+r.name+" .sp-grid-search-box").append(h)}}return p};a.prototype.complete_actions=function(){var e=this;
for(var f=0,d=e.actions.length;f<d;f++){var c=e.actions[f];if(typeof(c.type)==="string"){if(c.type==="new"){e.actions[f]=b.extend(e._new_default,c)
}else{if(c.type==="edit"){e.actions[f]=b.extend(e._edit_default,c)}else{if(c.type==="delete"){e.actions[f]=b.extend(e._delete_default,c)
}else{if(c.type==="docs"){e.actions[f]=b.extend(e._docs_default,c)}}}}}}};a.prototype.loadActions=function(){var f=this;
var d="";if(f.actions!=null){if(f.actions.length===undefined){var c=b.extend(true,{url:"{{tg.url('/dashboard/grid_actions/')}}",type:"post",data:{cls:f.cls},success:function(i){if(i.status){f.actions=i.actions
}f.complete_actions();b("#"+f.name+" .actions").html(f._loadActions(f.actions))}},f.actions);
b.ajax(c)}else{f.complete_actions();b("#"+f.name+" .actions").html(f._loadActions(f.actions))
}}b("#"+f.name+" .sp-grid-cell").live("click",function(j){if(b(this).attr("clickable")=="true"){b("#"+f.name+" .sp-grid-select-all").attr("checked",false);
var i=b(this).parent().find(".sp-grid-rowid");b("#"+f.name+" .sp-grid-rowid").each(function(){var l=j.ctrlKey||j.metaKey;
if(b(this)!=i&&!f.multiselect&&!l){b(this).attr("checked",false)}});if(i.attr("checked")==true){i.attr("checked",false)
}else{i.attr("checked",true)}}});function h(l,m){var i="";if(m!="_blank"){var i=f.url_base+"?q="+encodeURI(f.q).replace("-","%2D","g").replace('"',"%22","g").replace("+","%2B","g").replace("#","%23","g")+"&rp="+f.rp+"&pag_n="+f.pag_n+"&ch_attr="+f.ch_attr+"&parent_id="+f.parent_id
}var j='<form type="post" action="'+l+'" target="'+m+'">\n<input type="hidden" name="came_from" value="'+i+'"/>\n';
if(f.ch_attr){j+='<input type="hidden" name="_'+f.ch_attr+'" value="'+f.parent_id+'"/>\n'
}j+="</form>\n";return j}function e(p,l,j,m){if(typeof(j.type)==="string"){var i=j.url;
if(i[i.length-1]!="/"){i+="/"}var n="";if(m){n="_blank"}if(j.type=="process"){if(j.require_id){if(p){i+=p
}else{f.warningSelectedId();return}}else{if(p){i+=p}}}else{if(j.type=="new"){i+=sprintf("%s/",f.cls)
}else{if(j.type=="delete"){f.std_delete(l,j.url);return}else{if(j.require_id){if(p){i+=sprintf("%s/%s",f.cls,p)
}else{f.warningSelectedId();return}}else{if(p){i+=sprintf("%s/%s",f.cls,p)}else{i+=sprintf("%s/",f.cls)
}}}}}b(h(i,n)).appendTo("body").submit().remove()}else{var o=l;if(j.require_id){if(o.length>0){j.type.f(o[0],o)
}else{f.warningSelectedId();return}}else{if(o.length>0){j.type.f(o[0],o)}else{j.type.f()
}}}}function g(j,m,l){var i=f.getAction(m);var n=j.parent().parent().find(".sp-grid-rowid").attr("id_row");
e(n,[],i,l)}b("#"+f.name+" .new_inline").live("click",function(i){g(b(this),"new",i.ctrlKey||i.metaKey)
});if(f.actions_inline){b("#"+f.name+" .edit_inline").live("click",function(i){g(b(this),"edit",i.ctrlKey||i.metaKey)
});b("#"+f.name+" .delete_inline").live("click",function(l){var j=f.getSelectedIds();
if(j.length==0){var m=b(this).parent().parent().find(".sp-grid-rowid").attr("id_row");
j=[m]}var i=f.getAction("delete");f.std_delete(j,i.url)});b("#"+f.name+" .docs_inline").live("click",function(i){g(b(this),"docs")
});b("#"+f.name+" .nonstd_actions").live("change",function(j){var i=b(this).val();
if(i){g(b(this),i)}})}else{b("#"+f.name+" .sp-grid-button-action").live("click",function(j){var i=f.getAction(b(this).attr("id"));
var l=f.getSelectedIds();e(l[0],l,i,j.ctrlKey||j.metaKey)})}b("#grid-export_"+f.name).live("change",function(){var n=b("#grid-export_"+f.name+" option:selected").val();
if(n==""){return}var j=f.exportable_formats;var s="";if(typeof(f.exportable)=="object"){j=f.exportable.formats;
if(f.exportable.data){for(k in f.exportable.data){var o=f.exportable.data[k];if(typeof(o)=="function"){o=o()
}s+='<input type="hidden" name="'+k+'" value="'+o+'">'}}}var q="";for(var r=0,m=j.length;
r<m;r++){if(j[r].id==n){q=j[r].url;break}}var p='<form action="'+q+'" method="get" ><input type="hidden" name="cls" value="'+f.cls+'"><input type="hidden" name="q" value="'+f.q+'"><input type="hidden" name="ch_attr" value="'+f.ch_attr+'"><input type="hidden" name="parent_id" value="'+f.parent_id+'">'+s+"</form>";
b(p).appendTo("body").submit().remove();b(this).find("option:first").attr("selected",true)
})};a.prototype.std_delete=function(g,f){var e=this;var d=e.cls;var j=JSON.stringify(g);
var h="<p id='delete-question'>{{_('Do you really want to delete this record?')}}</p><p id='object-title'></p>";
var c="<p id='delete-error-title'>{{_('Oops, something went wrong...')}}</p><div id='delete-error-message'></div>";
b("#grid-dialog_"+e.name).html(h);var i="";b.ajax({url:"{{tg.url('/dashboard/title')}}",type:"get",dataType:"json",data:{cls:d,id:j},success:function(l){if(l.status){var m;
if(typeof(l.title)=="string"){m=l.title}else{m=l.title.join(" | ")}b("#grid-dialog_"+e.name+" #object-title").html(m)
}},error:function(){}});b("#grid-dialog_"+e.name).dialog({width:650,height:210,resizable:false,modal:true,title:"{{_('Delete')}}",buttons:{"{{_('Ok')}}":function(){b.ajax({url:f,type:"get",dataType:"json",data:{cls:d,id_:j},success:function(m){if(m.status){e.search(e.q,true);
b("#grid-dialog_"+e.name).dialog("close")}else{b("#grid-dialog_"+e.name).dialog("close");
var n="<p style='color: gray;'>"+m.message+"</p>";if(m.rel_tables!=undefined&&m.rel_tables.length>0){n+="<div>{{_('For your information this object is related with other objects in the following classes:')}}</div>";
n+="<ul>";for(var l=0;l<m.rel_tables.length;l++){var p=m.rel_tables[l].class_title;
var o=m.rel_tables[l].attr_title;n+='<li><span style="font-weight: bold;">'+p+'</span> (<span style="color: gray;">'+o+"</span>)</li>"
}n+="</ul>"}b("#grid-dialog_"+e.name).html(c).find("#delete-error-message").html(n);
b("#grid-dialog_"+e.name).dialog({width:700,height:250,buttons:{"{{_('Close')}}":function(){b("#grid-dialog_"+e.name).dialog("close")
}}})}},error:function(){b("#grid-dialog_"+e.name).dialog("close");b("#grid-dialog_"+e.name).html(c).dialog({buttons:{"{{_('Close')}}":function(){b("#grid-dialog_"+e.name).dialog("close")
}}})}})},"{{_('Cancel')}}":function(){b("#grid-dialog_"+e.name).dialog("close")}}})
};a.prototype.selectAll=function(c){var d=this;if(c===undefined){c=true}b("#"+d.name+" .sp-grid-rowid").attr("checked",c)
};b.fn.sapnsGrid=function(m,i,h){if(typeof(m)=="object"){var l=new a(m);this.data("sapnsGrid",l);
this.append(sprintf('<div id="grid-dialog_%(name)s" style="display: none;"></div>',{name:l.name}));
var u="";u+=sprintf('<div class="sp-grid-container" id="%(name)s" cls="%(cls)s">',{name:l.name,cls:l.cls});
if(l.caption){u+=sprintf('<div class="sp-grid-caption">%(caption)s</div>',{caption:l.caption})
}if(l.with_search){u+='<div><div class="sp-grid-search-box"><input class="sp-search-txt" style="float: left;" name="q" type="text" value=""><img class="inline_action sp-search-btn" src="{{tg.url("/images/sapns/icons/search.png")}}" title="{{_("Search...")}}" style="margin-left: 5px;"></div>';
b("#"+l.name+" .sp-search-btn").live("click",function(){l.search(b("#"+l.name+" .sp-search-txt").val())
});b("#"+l.name+" .sp-search-txt").live("keypress",function(g){if(g.which==13){l.search(b(this).val())
}});if(l.link){u+="<div style=\"padding-left: 20px;\"><button id='link-shortcut' class='sp-button' style='float: left;'>{{_('Create a shortcut')}}</button><div style=\"font-size: 9px; margin-top: 7px; width: 100px; float: left;\"><a id='this-search' href='"+l.link+"' target='_blank'>[{{_('this search')}}]</a></div><div id=\"link-shortcut-dialog\" style=\"display: none;\"><p>{{_('Do you want to create a shortcut for this search?')}}</p><label>{{_('Shortcut title')}}:</label><input id='link-shortcut-title' type='text' value='({{_('title')}})'></div></div>"
}u+="</div>"}var p='<div class="sp-grid-parent" style="overflow: auto; clear: left; height: '+(l.height+5)+'px; background-color: transparent;"></div>';
var e="";if(l.with_pager){e+='<div class="sp-grid-pager"><div class="sp-grid-pager-desc"></div>';
var o="",f="",t="",r="";var d=" selected";var j="";if(l.rp==10){o=d}else{if(l.rp==50){f=d
}else{if(l.rp==100){t=d}else{if(l.rp==0){r=d}else{j='<option value="'+l.rp+'" selected>'+l.rp+"</option>"
}}}}e+='<div style="float: left; clear: right; height: 25px; margin-top: 2px;"><select class="sp-button sp-grid-rp">'+j+'<option value="10"'+o+'>10</option><option value="50"'+f+'>50</option><option value="100"'+t+'>100</option><option value="0"'+r+'>{{_("All")}}</option></select><button class="sp-button sp-grid-first-page" style="float: left;">|&lt;&lt;</button><button class="sp-button sp-grid-page-back" style="float: left;">&lt;&lt;</button><input class="sp-grid-current-page" type="text" style="text-align: center; font-size: 11px; margin-top: 3px;" readonly><button class="sp-button sp-grid-page-forth" style="float: left;">&gt;&gt</button><button class="sp-button sp-grid-last-page" style="float: left;">&gt;&gt|</button></div>';
e+="</div>";b("#"+l.name+" .sp-grid-select-all").live("click",function(){var g=b(this).attr("checked");
l.selectAll(g)});b("#"+l.name+" .sp-grid-rp").live("change",function(){l.rp=b(this).val();
l.pag_n=1;l.search(l.q)});b("#"+l.name+" .sp-grid-first-page").live("click",function(){l.pag_n=1;
l.search(l.q)});b("#"+l.name+" .sp-grid-page-back").live("click",function(){if(l.pag_n>1){l.pag_n-=1;
l.search(l.q)}});b("#"+l.name+" .sp-grid-page-forth").live("click",function(){if(l.pag_n<l.total_pag){l.pag_n*=1;
l.pag_n+=1;l.search(l.q)}});b("#"+l.name+" .sp-grid-last-page").live("click",function(){l.pag_n=l.total_pag;
l.search(l.q)})}var n='<div class="sp-grid-button-actions" style="display: none;"></div>';
this.append(u+n+p+e+"</div>");l.loadActions();b("#"+l.name+" .sp-search-txt").val(l.q);
l.search(l.q)}else{if(typeof(m)=="string"){var s=this.data("sapnsGrid");if(m=="loadData"){s.loadData()
}else{if(m=="search"){var c="";if(typeof(i)=="boolean"){c=s.q}else{if(i){c=i}}if(s.with_search){b("#"+s.name+" .sp-search-txt").val(c)
}s.search(c,true,h)}else{if(m=="getSelectedIds"){return s.getSelectedIds()}else{if(m=="setRp"){s.rp=i;
b("#"+s.name+" .sp-grid-rp [value="+i+"]").attr("selected",true)}else{if(m=="selectAll"){s.selectAll()
}}}}}}}return this}})(jQuery);